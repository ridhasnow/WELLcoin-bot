<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WELLcoin Test Mission</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    body { background: black; color: white; font-family: sans-serif; padding: 40px; }
    .mission { background: #111; padding: 20px; border: 1px solid gold; border-radius: 12px; }
    button { padding: 10px 20px; border: none; border-radius: 6px; background: gold; color: black; font-weight: bold; cursor: pointer; }
    button:disabled { background: gray; cursor: not-allowed; }
  </style>
</head>
<body>
  <h2>üî• Test Mission</h2>
  <div class="mission">
    <p>Click once to claim 0.01 WLC</p>
    <button id="claim-btn" onclick="claimTest()">Claim</button>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCpb7_zDJ1UlH3OkfhfGI1V5FTS40xH82A",
      authDomain: "wellcoin-game.firebaseapp.com",
      projectId: "wellcoin-game",
      storageBucket: "wellcoin-game.appspot.com",
      messagingSenderId: "586431048382",
      appId: "1:586431048382:web:b8cb6a9ef17d06e261c437",
      databaseURL: "https://wellcoin-game-default-rtdb.europe-west1.firebasedatabase.app"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let userId = null;

    async function getUserData() {
      const snap = await db.ref(`users/${userId}`).once("value");
      return snap.val() || {};
    }

    async function updateUserData(data) {
      await db.ref(`users/${userId}`).update(data);
    }

    async function updateUserBalance(amount) {
      const user = await getUserData();
      const balance = parseFloat(user.balance || 0) + amount;
      await updateUserData({ balance });
    }

    async function claimTest() {
      const user = await getUserData();
      const alreadyClaimed = user.missions?.testClaimed;

      if (alreadyClaimed) {
        alert("Already claimed ‚úÖ");
        return;
      }

      await updateUserData({
        missions: {
          ...(user.missions || {}),
          testClaimed: true
        }
      });

      await updateUserBalance(0.01);
      const btn = document.getElementById("claim-btn");
      btn.disabled = true;
      btn.textContent = "Claimed ‚úÖ";
      alert("üéâ Claimed successfully!");
    }

    window.onload = () => {
      const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
      if (tgUser && tgUser.id) {
        userId = tgUser.id.toString();
      } else {
        alert("‚ùå Failed to get Telegram user.");
      }
    };
  </script>
</body>
</html>
