<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>Missions</title>

  <!-- Preconnect to speed up first DB and SDK handshakes -->
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://wellcoinbotgame-default-rtdb.europe-west1.firebasedatabase.app" crossorigin>

  <!-- Telegram + Firebase (compat, unified) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <!-- Preload assets for instant paint (kept) -->
  <link rel="preload" as="image" href="assets/youtube-icon.png"/>
  <link rel="preload" as="image" href="assets/telegram-icon.png"/>
  <link rel="preload" as="image" href="assets/instagram-icon.png"/>
  <link rel="preload" as="image" href="assets/facebook-icon.png"/>
  <link rel="preload" as="image" href="assets/tiktok-icon.png"/>
  <link rel="preload" as="image" href="assets/twitter-icon.png"/>
  <link rel="preload" as="image" href="assets/daily-icon.png"/>
  <link rel="preload" as="image" href="assets/invit1.png"/>
  <link rel="preload" as="image" href="assets/invit2.png"/>
  <link rel="preload" as="image" href="assets/invit3.png"/>

  <style>
    :root{
      --gold:#d4af37;
      --gold-2:#ffd76a;
      --ok:#19ff74;
      --txt:#fff;
      --muted:#ddd;
      --card:#2a2a2a;
      --card2:#1a1a1a;
    }
    body {
      background: #000;
      color: var(--txt);
      font-family: 'Segoe UI', system-ui, -apple-system, Roboto, Ubuntu, 'Helvetica Neue', Arial, sans-serif;
      padding: 20px;
      margin: 0;
      -webkit-text-size-adjust: 100%;
    }
    .header-box {
      background: var(--card2);
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      margin-bottom: 18px;
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
    }
    .header-box h1 {
      font-size: 26px;
      background: linear-gradient(90deg, gold, white);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 0 6px rgba(255, 215, 0, 0.4);
      margin: 0;
    }

    /* Back button — guaranteed return to index.html */
    #back-btn {
      position: absolute;
      top: 16px;
      left: 16px;
      width: 26px; height: 26px;
      background: white;
      border: none; border-radius: 6px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.13);
      transition: background 0.18s, transform .12s;
      z-index: 1000;
      padding: 0;
    }
    #back-btn:hover { background: #f7f7f7; }
    #back-btn:active { transform: scale(0.98); }
    #back-btn svg { width: 16px; height: 16px; display: block; }

    /* Skeleton loader (instant paint, modern shimmer) */
    #skeleton { margin-top: 6px; }
    .skel-mission{
      height: 84px; border-radius:12px; margin-bottom:18px;
      background: #2a2a2a;
      border:1px solid rgba(255,215,106,.18);
      position: relative; overflow: hidden;
    }
    .skel-mission::after{
      content:""; position:absolute; inset:0;
      background: linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.07), rgba(255,255,255,0));
      transform: translateX(-100%);
      animation: shimmer 1.2s ease-in-out infinite;
    }
    @keyframes shimmer { to { transform: translateX(100%); } }

    #missions { display: flex; flex-direction: column; gap: 18px; }

    .mission {
      position: relative;
      display: flex;
      align-items: center;
      background: var(--card);
      border-radius: 12px;
      padding: 14px;
      /* Thin golden edge + sharp subtle glow (no rotating animation) */
      border: 1px solid rgba(255, 215, 106, 0.32);
      box-shadow:
        0 0 0.5px rgba(255,215,106,0.65),
        0 0 7px rgba(255,215,106,0.18);
      overflow: hidden;
      isolation: isolate;
    }

    /* Images — block long-press/save */
    .mission img {
      width: 56px; height: 56px; margin-right: 14px; flex-shrink: 0; z-index: 2;
      -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; -webkit-user-drag: none;
      pointer-events: none;
      border-radius: 10px;
    }

    .mission-content { flex: 1; color: white; z-index: 2; }
    .mission-content h3 { margin: 0 0 6px; font-size: 17px; }
    .mission-content p  { margin: 0; font-size: 13px; color: var(--muted); }

    /* Progress bar */
    .progress-container {
      width: 100%; background: #444; border-radius: 10px; height: 12px; margin-top: 8px;
      overflow: hidden; position: relative;
    }
    .progress-bar {
      height: 12px; border-radius: 10px;
      background: linear-gradient(90deg, #ff2e2e 0%, orange 60%, #6fff00 100%);
      box-shadow: 0 0 10px 1px #fff700c7, 0 0 4px 1px #b6b000a4;
      position: relative; transition: width 0.5s cubic-bezier(.77,.2,.05,1.0);
    }
    .progress-bar.gold{
      background: linear-gradient(90deg, #a67c00 0%, #d4af37 40%, #ffd76a 70%, #a67c00 100%);
      box-shadow: 0 0 8px 1px rgba(212,175,55,.6), 0 0 3px 1px rgba(255,215,106,.5);
    }

    /* Smaller action buttons */
    .mission button {
      padding: 8px 12px;
      background: var(--ok);
      color: #000;
      font-weight: 700;
      font-size: 13px;
      border: none; border-radius: 8px;
      cursor: pointer;
      margin-left: 10px;
      z-index: 2;
      transition: transform .12s, filter .16s;
      min-width: 84px;
    }
    .mission button:hover { filter: brightness(1.05); }
    .mission button:active { transform: translateY(1px) scale(0.99); }
    .mission button:disabled {
      background: #c2c2c2; cursor: not-allowed; color: #555;
    }

    /* Modern modal */
    .modal {
      position: fixed; inset: 0; display: none; place-items: center; z-index: 9999;
      background: rgba(0,0,0,.56); backdrop-filter: blur(4px);
    }
    .modal.open { display: grid; }
    .modal-card{
      width: min(94vw, 420px);
      background: #0f1115;
      color: #eaf2ff;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 10px 30px rgba(0,0,0,.5);
      padding: 18px 16px 14px 16px;
      position: relative;
      overflow: hidden;
    }
    .modal-card h3{
      margin: 0 0 8px;
      font-size: 18px;
      background: linear-gradient(90deg, #fff, #dfe9ff);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .modal-card p{ margin: 6px 0; color: #cbd6f6; font-size: 14px; }
    .modal-actions{ margin-top: 12px; display: flex; gap: 8px; justify-content: center; }
    .btn{
      padding: 9px 14px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      color: #fff; font-weight: 800; letter-spacing: .2px; cursor: pointer;
      transition: transform .12s, filter .16s;
    }
    .btn.primary{ background: linear-gradient(180deg, #0a84ff, #0a6bff); }
    .btn.success{ background: linear-gradient(180deg, #17c964, #0b9d56); color:#001a10; }
    .btn.warning{ background: linear-gradient(180deg, #ffcc00, #f0b400); color:#2b1d00; }
    .btn:active{ transform: translateY(1px); }

    .close-x{
      position:absolute; top:8px; right:10px; width:26px; height:26px;
      display:grid; place-items:center; border-radius:8px; border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04)); color:#fff; cursor:pointer;
    }

    /* Confetti */
    .confetti{
      position:absolute; inset:0; pointer-events:none; overflow:hidden; z-index: 2;
    }
    .confetti .piece{
      position:absolute; width:9px; height:14px; opacity:.98; border-radius:2px;
      will-change: transform, opacity;
      animation: confetti-fall 1200ms ease-out forwards;
    }
    @keyframes confetti-fall{
      0%  { transform: translate(var(--x0), -24px) rotate(var(--r0)); opacity:1; }
      100%{ transform: translate(var(--x1), var(--y1)) rotate(calc(var(--r0) + 540deg)); opacity:0; }
    }

    /* Global block: long press/context menu on images */
    img, svg { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; -webkit-user-drag: none; }
  </style>
</head>
<body>
  <button id="back-btn" aria-label="Back">
    <svg viewBox="0 0 24 24" fill="none"><path d="M15.5 19l-7-7 7-7" stroke="#111" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
  </button>

  <div class="header-box"><h1>You Can Do It</h1></div>

  <!-- Skeleton appears instantly; hidden on first data render -->
  <div id="skeleton" aria-hidden="true">
    <div class="skel-mission"></div>
    <div class="skel-mission"></div>
    <div class="skel-mission"></div>
    <div class="skel-mission"></div>
  </div>

  <div id="missions"></div>

  <script>
    // Prevent image context / long-press
    (function preventMediaLongPress(){
      try{
        document.addEventListener('contextmenu', e=>{
          if (e.target && (e.target.tagName === 'IMG' || e.target.closest('img'))) e.preventDefault();
        }, true);
        ['touchstart','touchend','touchcancel','gesturestart'].forEach(ev=>{
          document.addEventListener(ev, (e)=>{
            const t = e.target;
            if (t && (t.tagName === 'IMG' || t.closest('img'))) e.preventDefault();
          }, {passive:false});
        });
      }catch{}
    })();

    // Telegram + Firebase init
    const tg = window.Telegram?.WebApp;
    try { tg && tg.ready(); } catch(e){}
    const firebaseConfig = {
      apiKey: "AIzaSyB9uNwUURvf5RsD7CnsG2LtE6fz5yboBkw",
      authDomain: "wellcoinbotgame.firebaseapp.com",
      databaseURL: "https://wellcoinbotgame-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "wellcoinbotgame",
      storageBucket: "wellcoinbotgame.appspot.com",
      messagingSenderId: "108640533638",
      appId: "1:108640533638:web:ed07516d96ac38f47f6507"
    };
    const app = (firebase.apps && firebase.apps.length) ? firebase.app() : firebase.initializeApp(firebaseConfig);
    const db  = firebase.database(app);

    // Reliable server time
    let serverOffset = 0;
    let lastUser = null;
    db.ref(".info/serverTimeOffset").on("value", s=>{
      serverOffset = s.val() || 0;
      // Repaint timers precisely when offset updates
      if (lastUser) renderAll(lastUser);
    });
    const now = ()=> Date.now() + serverOffset;

    // IndexedDB cache (no localStorage dependency)
    const IDB_NAME='wellcoin_game_cache', IDB_STORE='cache';
    function openIDB(){ return new Promise((res,rej)=>{ const r=indexedDB.open(IDB_NAME,1); r.onupgradeneeded=()=>{const db=r.result; if(!db.objectStoreNames.contains(IDB_STORE)) db.createObjectStore(IDB_STORE);}; r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error);});}
    function idbGet(key){ return openIDB().then(db=>new Promise((res,rej)=>{ const tx=db.transaction(IDB_STORE,'readonly'); const rq=tx.objectStore(IDB_STORE).get(key); rq.onsuccess=()=>res(rq.result); rq.onerror=()=>rej(rq.error);}));}
    function idbSet(key,val){ return openIDB().then(db=>new Promise((res,rej)=>{ const tx=db.transaction(IDB_STORE,'readwrite'); tx.objectStore(IDB_STORE).put(val,key); tx.oncomplete=res; tx.onerror=()=>rej(tx.error);}));}
    // Warm IDB channel early
    openIDB().catch(()=>{});

    // User id from session (no localStorage)
    function getStoredUserId(){
      try{
        return sessionStorage.getItem('wlc_user_id') || tg?.initDataUnsafe?.user?.id || null;
      }catch{ return tg?.initDataUnsafe?.user?.id || null; }
    }
    const userId = String(getStoredUserId() || '');
    try { if (userId) sessionStorage.setItem('wlc_user_id', userId); } catch {}

    // Session snapshot for instant paint (kept in sessionStorage)
    function readSessionSnapshot(){
      try {
        const raw = sessionStorage.getItem('wlc_user_snapshot');
        if (!raw) return null;
        const u = JSON.parse(raw);
        return u && typeof u === 'object' ? u : null;
      } catch { return null; }
    }
    function writeSessionSnapshot(user){
      try { sessionStorage.setItem('wlc_user_snapshot', JSON.stringify(user)); } catch {}
    }

    // Cache helpers (IndexedDB)
    const userCacheKey = uid => `user:${uid}`;
    async function readCachedUser(uid){
      try{ const v = await idbGet(userCacheKey(uid)); return v || null; }catch{ return null; }
    }
    async function writeCachedUser(uid, data){
      try{ await idbSet(userCacheKey(uid), data); }catch{}
    }

    // UI refs
    const backBtn = document.getElementById('back-btn');
    const missionsDiv = document.getElementById('missions');
    const skeleton = document.getElementById('skeleton');
    function hideSkeleton(){ if (skeleton) skeleton.style.display='none'; }
    function showSkeleton(){ if (skeleton) skeleton.style.display='block'; }

    // Back: always return to index.html (replace to avoid stacking)
    backBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      try{
        const a = document.getElementById('preloadAudio');
        if (a) {
          sessionStorage.setItem('wlc_music_ct', String(a.currentTime||0));
          sessionStorage.setItem('wlc_music_track','assets/preload.mp3');
          if (!sessionStorage.getItem('wlc_music_started_at_ms')) {
            sessionStorage.setItem('wlc_music_started_at_ms', String(Date.now() - (a.currentTime || 0) * 1000));
          }
        }
      }catch{}
      window.location.replace('index.html');
    });

    // Utils
    function openSmart(url){
      try{
        let u = String(url||'').trim();
        if (!/^https?:\/\//i.test(u) && !/^tg:|^tme:|^mailto:/i.test(u)) {
          u = 'https://' + u.replace(/^\/+/, '');
        }
        if (/^https?:\/\/t\.me\/|^tg:|^tme:/i.test(u)){
          if (tg && typeof tg.openTelegramLink === 'function') tg.openTelegramLink(u);
          else window.open(u, '_blank');
        } else {
          if (tg && typeof tg.openLink === 'function') tg.openLink(u, { try_instant_view: false });
          else window.open(u, '_blank');
        }
      }catch{ window.open(url, '_blank'); }
    }
    async function getUserOnce(uid){
      const snap = await db.ref('users/'+uid).once('value');
      return snap.val() || {};
    }
    async function updateUser(uid, data){
      return db.ref('users/'+uid).update(data);
    }
    function txReferrals(uid, delta=1){
      const ref = db.ref('users/'+uid+'/referrals');
      return ref.transaction(v => (typeof v === 'number' ? v : Number(v||0)) + delta);
    }
    function markReferral(inviterId, newUid){
      return db.ref('referrals/'+inviterId+'/'+newUid).set(firebase.database.ServerValue.TIMESTAMP);
    }
    // balance helpers
    async function addWLC(uid, delta){
      const ref = db.ref('users/'+uid+'/balance');
      await ref.transaction(v => (typeof v === 'number' ? v : Number(v||0)) + Number(delta||0));
    }
    async function addUSDT(uid, delta){
      const ref = db.ref('users/'+uid+'/usdtBalance');
      await ref.transaction(v => (typeof v === 'number' ? v : Number(v||0)) + Number(delta||0));
    }

    // Modal helpers
    function showModal(contentNode){
      const m = document.createElement('div');
      m.className = 'modal open';
      const card = document.createElement('div');
      card.className = 'modal-card';
      const close = document.createElement('button');
      close.className = 'close-x';
      close.innerHTML = '✕';
      close.onclick = ()=> m.remove();
      card.appendChild(close);
      card.appendChild(contentNode);
      m.appendChild(card);
      document.body.appendChild(m);
      return { modal:m, card };
    }
    function makeConfirmVisitModal(title, body, yesLabel, onYes){
      const wrap = document.createElement('div');
      const h = document.createElement('h3'); h.textContent = title; wrap.appendChild(h);
      const p = document.createElement('p'); p.innerHTML = body; wrap.appendChild(p);
      const actions = document.createElement('div'); actions.className='modal-actions';
      const yes = document.createElement('button'); yes.className='btn success'; yes.textContent = yesLabel || 'Yes';
      const later = document.createElement('button'); later.className='btn'; later.textContent = 'Later';
      actions.appendChild(yes); actions.appendChild(later);
      wrap.appendChild(actions);
      const { modal } = showModal(wrap);
      later.onclick = ()=> modal.remove();
      yes.onclick = async()=>{ try{ await onYes?.(); } finally{ modal.remove(); } };
    }
    function makeInviteModal(link){
      const wrap = document.createElement('div');
      const h = document.createElement('h3'); h.textContent = 'Invite Friends'; wrap.appendChild(h);
      const p1 = document.createElement('p');
      p1.innerHTML = `<strong>Your referral link:</strong><br><span style="word-break:break-word;color:#fff">${link}</span>`;
      const p2 = document.createElement('p'); p2.style.color = '#ffb86b';
      p2.style.fontSize = '13px';
      p2.innerHTML = 'Warning: Fake referrals from the same device will be checked. Violations may lead to penalties.';
      wrap.appendChild(p1); wrap.appendChild(p2);
      const actions = document.createElement('div'); actions.className='modal-actions';
      const copy = document.createElement('button'); copy.className='btn warning'; copy.textContent = 'Copy';
      const share = document.createElement('button'); share.className='btn primary'; share.textContent = 'Share';
      actions.appendChild(share); actions.appendChild(copy);
      wrap.appendChild(actions);
      const { modal } = showModal(wrap);

      share.onclick = async ()=>{
        try{
          if (navigator.share){
            await navigator.share({ title:'WELLcoin', text:'Join WELLcoin game and earn with me!', url: link });
          }else if (tg && typeof tg.openTelegramLink === 'function'){
            const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent('Join WELLcoin game and earn with me!')}`;
            tg.openTelegramLink(shareUrl);
          }else{
            window.open(`https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent('Join WELLcoin game and earn with me!')}`,'_blank');
          }
        }catch{}
        modal.remove();
      };
      copy.onclick = ()=>{
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(link).then(()=>{ modal.remove(); });
        } else {
          // Fallback
          const ta = document.createElement('textarea');
          ta.value = link; document.body.appendChild(ta);
          ta.select(); try { document.execCommand('copy'); } catch {}
          ta.remove(); modal.remove();
        }
      };
    }

    // Confetti overlay on the modal
    function fireConfetti(container){
      const c = document.createElement('div'); c.className='confetti';
      container.appendChild(c);
      const colors = ['#ff4757','#fffa65','#2ed573','#1e90ff','#eccc68','#ffa502','#7bed9f','#70a1ff','#ff6b81'];
      const rect = container.getBoundingClientRect();
      const pieces = 140;
      for (let i=0;i<pieces;i++){
        const piece = document.createElement('div'); piece.className='piece';
        piece.style.background = colors[(Math.random()*colors.length)|0];
        const x0 = (rect.width/2) + (Math.random()*90 - 45);
        const x1 = Math.random()*rect.width;
        const y1 = rect.height + 100 + Math.random()*120;
        const r0 = (Math.random()*180 - 90) + 'deg';
        piece.style.setProperty('--x0', x0+'px');
        piece.style.setProperty('--x1', x1+'px');
        piece.style.setProperty('--y1', y1+'px');
        piece.style.setProperty('--r0', r0);
        piece.style.left = '0px'; piece.style.top = '0px';
        piece.style.animationDuration = (1000 + Math.random()*800)+'ms';
        c.appendChild(piece);
        setTimeout(()=> piece.remove(), 2200);
      }
      setTimeout(()=> c.remove(), 2300);
    }
    function showCongratsModal(textHTML){
      const wrap = document.createElement('div');
      const h = document.createElement('h3'); h.textContent = 'Well done!'; wrap.appendChild(h);
      const p = document.createElement('p'); p.innerHTML = textHTML; wrap.appendChild(p);
      const actions = document.createElement('div'); actions.className='modal-actions';
      const ok = document.createElement('button'); ok.className='btn success'; ok.textContent = 'OK';
      actions.appendChild(ok); wrap.appendChild(actions);
      const { modal } = showModal(wrap);
      fireConfetti(modal);
      ok.onclick = ()=> modal.remove();
    }

    // Render helpers
    function renderMission({ id, title, desc, icon, reward, progress=null, claimed=false, disabled=false, buttonText="", onClick, progressTheme=null, extraClasses='' }){
      const div = document.createElement('div');
      div.className = `mission ${extraClasses||''}`;
      const progressHTML = (progress !== null) ? `
          <div class="progress-container">
            <div class="progress-bar ${progressTheme==='gold' ? 'gold':''}" style="width:${Math.max(0, Math.min(100, progress))}%"></div>
          </div>
          <p style="margin-top:4px; font-size:12px;">${Math.round(progress)}%</p>
        ` : '';
      div.innerHTML = `
        <img src="${icon}" alt="${title}" draggable="false" oncontextmenu="return false"/>
        <div class="mission-content">
          <h3>${title}</h3>
          <p>${desc}</p>
          ${progressHTML}
        </div>
        <button id="btn-${id}" ${disabled ? 'disabled' : ''}>${buttonText}</button>
      `;
      missionsDiv.appendChild(div);
      const btn = div.querySelector('#btn-'+id);
      if (btn) btn.onclick = onClick;
    }

    // Social tasks config
    const socials = [
      { id: "youtube",  title: "Follow us on YouTube",   icon: "assets/youtube-icon.png",   url: "https://www.youtube.com/@WELLcoin-y6b", reward: 1, type: "follow" },
      { id: "telegram", title: "Join our Telegram",      icon: "assets/telegram-icon.png",  url: "https://t.me/WELLcoinofficial",          reward: 1, type: "join"   },
      { id: "instagram",title: "Follow us on Instagram", icon: "assets/instagram-icon.png", url: "https://instagram.com/WELLcoin1",        reward: 1, type: "follow" },
      { id: "facebook", title: "Like our Facebook page", icon: "assets/facebook-icon.png",  url: "https://www.facebook.com/profile.php?id=61562283616319", reward: 1, type: "follow" },
      { id: "tiktok",   title: "Follow us on TikTok",    icon: "assets/tiktok-icon.png",    url: "https://www.tiktok.com/@wellcoin6?_t=ZN-8zBdro3gOQB&_r=1", reward: 1, type: "follow" },
      { id: "x",        title: "Follow us on X (Twitter)",icon:"assets/twitter-icon.png",   url: "https://x.com/WELLcoin2024?s=09",        reward: 1, type: "follow" }
    ];

    // Invite missions config — rewards in USDT
    const inviteMissions = [
      { id: "invite5",   icon: "assets/invit1.png", label: "Invite 5 Friends",   target: 5,   rewardUSD: 0.2 },
      { id: "invite20",  icon: "assets/invit2.png", label: "Invite 20 Friends",  target: 20,  rewardUSD: 1 },
      { id: "invite100", icon: "assets/invit3.png", label: "Invite 100 Friends", target: 100, rewardUSD: 5 }
    ];

    // Defer preloading icons until idle to not compete with DB
    function preloadImages(){
      try{
        const urls = [
          ...socials.map(s=>s.icon),
          ...inviteMissions.map(i=>i.icon),
          "assets/daily-icon.png"
        ];
        urls.forEach(u => { const im = new Image(); im.decoding='async'; im.loading='eager'; im.src = u; });
      }catch{}
    }
    if ('requestIdleCallback' in window) requestIdleCallback(preloadImages); else setTimeout(preloadImages, 0);

    // Referral credit (server timestamp)
    let referralChecked = false;
    async function ensureReferralCredit(currentUser){
      if (referralChecked) return;
      referralChecked = true;
      try{
        const startParam = tg?.initDataUnsafe?.start_param || new URLSearchParams(location.search).get('ref');
        if (!startParam) return;
        const inviterId = String(startParam);
        if (!userId || !inviterId || inviterId === userId) return;

        const alreadyReferred = !!currentUser?.referredBy;
        if (alreadyReferred) return;

        await updateUser(userId, {
          referredBy: inviterId,
          referredAt: firebase.database.ServerValue.TIMESTAMP
        });
        await markReferral(inviterId, userId);
        await txReferrals(inviterId, +1);
      }catch(e){}
    }

    // Render
    function renderAll(user){
      lastUser = user;
      missionsDiv.innerHTML = '';
      const userMissions = user.missions || {};
      const getClaimed = (id)=> !!(userMissions[id]?.claimed);

      // Social tasks (WLC rewards)
      socials.forEach(({id, title, icon, url, reward, type})=>{
        const isClaimed = getClaimed(id);
        renderMission({
          id,
          title,
          desc: `Reward: ${reward} WLC`,
          icon,
          reward,
          claimed: isClaimed,
          buttonText: isClaimed ? "Visit" : (type === "join" ? "Join Now" : "Follow"),
          disabled: false,
          onClick: async function(){
            openSmart(url);
            if (isClaimed) return;

            makeConfirmVisitModal(
              'Confirm Task',
              'Did you complete this task? You will receive <b>'+reward+' WLC</b>.',
              'Yes, I did',
              async ()=>{
                await addWLC(userId, reward);
                // Mark claimed (server time)
                const updates = {};
                updates['users/'+userId+'/missions/'+id+'/claimed'] = true;
                updates['users/'+userId+'/missions/'+id+'/claimedAt'] = firebase.database.ServerValue.TIMESTAMP;
                await db.ref().update(updates);
                // Refresh caches
                const fresh = await getUserOnce(userId).catch(()=>user);
                await writeCachedUser(userId, fresh);
                writeSessionSnapshot(fresh);
                showCongratsModal(`You earned <b>${reward} WLC</b>!`);
              }
            );
          }
        });
      });

      // Daily reward (WLC) — server-time-based
      const dailyId = 'daily';
      const lastClaim = Number(userMissions[dailyId]?.lastClaim || 0);
      const elapsed = now() - lastClaim;
      const oneDay = 24*60*60*1000;
      const available = elapsed > oneDay;
      const remaining = Math.max(0, oneDay - elapsed);
      const dailyDesc = available ? "Claim your 1 WLC!" : `<span id="daily-timer">Time left: ${formatTime(remaining)}</span>`;

      renderMission({
        id: dailyId,
        title: "Daily Reward",
        desc: dailyDesc,
        icon: "assets/daily-icon.png",
        reward: 1,
        claimed: !available,
        disabled: !available,
        buttonText: "Claim",
        onClick: async function(){
          if (!available) return;
          await addWLC(userId, 1);
          // Server timestamp for lastClaim
          await db.ref('users/'+userId+'/missions/'+dailyId+'/lastClaim').set(firebase.database.ServerValue.TIMESTAMP);
          const fresh = await getUserOnce(userId).catch(()=>user);
          await writeCachedUser(userId, fresh);
          writeSessionSnapshot(fresh);
          showCongratsModal('You claimed <b>1 WLC</b> daily reward!');
        }
      });

      // Live daily timer (server time)
      if (!available){
        let prev = remaining;
        const tick = ()=>{
          const rem = Math.max(0, oneDay - (now() - lastClaim));
          const el = document.getElementById('daily-timer');
          if (el) el.textContent = 'Time left: ' + formatTime(rem);
          if (rem <= 0) {
            renderAll(user);
            return;
          }
          setTimeout(tick, Math.max(500, 1000 - Math.abs(rem - prev)));
          prev = rem;
        };
        setTimeout(tick, 1000);
      }

      // Invites (USDT rewards)
      const refCountNum = (typeof user.referrals === 'number') ? user.referrals : Number(user.referrals||0);
      const inviteLink = `https://t.me/WELLcoinGameBot?startapp=${encodeURIComponent(userId)}`;

      inviteMissions.forEach(({id, label, icon, target, rewardUSD})=>{
        const achieved = refCountNum >= target;
        const alreadyClaimed = getClaimed(id);

        renderMission({
          id,
          title: label,
          desc: `Progress: ${refCountNum}/${target} – Reward: $${rewardUSD}`,
          icon,
          reward: rewardUSD,
          progress: Math.min((refCountNum/target)*100, 100),
          claimed: alreadyClaimed,
          disabled: alreadyClaimed,
          progressTheme: 'gold',
          extraClasses: 'invite',
          buttonText: alreadyClaimed ? "Claimed" : (achieved ? "Claim" : "Invite"),
          onClick: async function(){
            if (alreadyClaimed) return;

            if (!achieved){
              makeInviteModal(inviteLink);
              return;
            }

            // Claim USDT reward
            await addUSDT(userId, rewardUSD);
            const updates = {};
            updates['users/'+userId+'/missions/'+id+'/claimed'] = true;
            updates['users/'+userId+'/missions/'+id+'/claimedAt'] = firebase.database.ServerValue.TIMESTAMP;
            await db.ref().update(updates);

            const fresh = await getUserOnce(userId).catch(()=>user);
            await writeCachedUser(userId, fresh);
            writeSessionSnapshot(fresh);
            showCongratsModal(`You received <b>$${rewardUSD.toFixed(2)}</b> to your USDT balance!`);
          }
        });
      });

      // Skeleton is no longer needed once we've painted
      hideSkeleton();
    }

    // Timer formatter
    function formatTime(ms){
      let sec = Math.max(0, Math.floor(ms/1000));
      let h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60), s=sec%60;
      return [h,m,s].map(x=>String(x).padStart(2,'0')).join(':');
    }

    // Subscribe live user + render from session/IDB first
    async function boot(){
      if (!userId){ alert('Missing Telegram user. Please open from Telegram.'); return; }

      // 1) Try session snapshot (instant)
      const snapUser = readSessionSnapshot();
      if (snapUser) {
        renderAll(snapUser);
      } else {
        showSkeleton();
      }

      // 2) Then IDB cache as next-best
      if (!snapUser) {
        const cached = await readCachedUser(userId);
        if (cached) renderAll(cached);
      }

      // 3) Live subscription (authoritative)
      const ref = db.ref('users/'+userId);
      let first = true;
      ref.on('value', async snap=>{
        const user = snap.val() || {};
        await writeCachedUser(userId, user);
        writeSessionSnapshot(user);
        if (first){
          first = false;
          ensureReferralCredit(user).catch(()=>{});
        }
        renderAll(user);
      }, err=>{
        console.error('DB error', err);
        // Keep skeleton only if nothing painted yet
        if (!lastUser) missionsDiv.innerHTML = '<div style="opacity:.85">Error loading missions.</div>';
        hideSkeleton();
      });
    }

    window.addEventListener('load', boot);
  </script>
</body>
</html>
