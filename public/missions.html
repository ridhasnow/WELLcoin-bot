<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>Missions</title>

  <!-- Telegram + Firebase (compat) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <!-- Preload assets for instant paint -->
  <link rel="preload" as="image" href="assets/youtube-icon.png"/>
  <link rel="preload" as="image" href="assets/telegram-icon.png"/>
  <link rel="preload" as="image" href="assets/instagram-icon.png"/>
  <link rel="preload" as="image" href="assets/facebook-icon.png"/>
  <link rel="preload" as="image" href="assets/tiktok-icon.png"/>
  <link rel="preload" as="image" href="assets/twitter-icon.png"/>
  <link rel="preload" as="image" href="assets/daily-icon.png"/>
  <link rel="preload" as="image" href="assets/invit1.png"/>
  <link rel="preload" as="image" href="assets/invit2.png"/>
  <link rel="preload" as="image" href="assets/invit3.png"/>

  <style>
    :root{
      --gold:#d4af37;
      --gold-2:#ffd76a;
      --ok:#19ff74;
      --txt:#fff;
      --muted:#ddd;
      --card:#2a2a2a;
      --card2:#1a1a1a;

      /* LED ring controls (slower + softer by default) */
      --led-speed: 6s;     /* bigger = slower */
      --led-width: 1.2;    /* stroke width of the bright segment */
      --led-on: 3.2;       /* bright segment length (of 100 pathLength) */
      --led-off: 96.8;     /* gap after the segment */
      --led-faint: .06;    /* overall faint border glow */
      --led-ds1: .28;      /* outer glow intensity 1 */
      --led-ds2: .10;      /* outer glow intensity 2 */
    }
    body {
      background: #000;
      color: var(--txt);
      font-family: 'Segoe UI', system-ui, -apple-system, Roboto, Ubuntu, 'Helvetica Neue', Arial, sans-serif;
      padding: 20px;
      margin: 0;
      -webkit-text-size-adjust: 100%;
    }
    .header-box {
      background: var(--card2);
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      margin-bottom: 30px;
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
    }
    .header-box h1 {
      font-size: 26px;
      background: linear-gradient(90deg, gold, white);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 0 6px rgba(255, 215, 0, 0.4);
      margin: 0;
    }

    /* Back button — smaller */
    #back-btn {
      position: absolute;
      top: 16px;
      left: 16px;
      width: 26px;   /* smaller */
      height: 26px;  /* smaller */
      background: white;
      border: none;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.13);
      transition: background 0.18s, transform .12s;
      z-index: 1000;
      padding: 0;
    }
    #back-btn:hover { background: #f7f7f7; }
    #back-btn:active { transform: scale(0.98); }
    #back-btn svg { width: 16px; height: 16px; display: block; }

    #missions { display: flex; flex-direction: column; gap: 18px; }

    .mission {
      position: relative;
      display: flex;
      align-items: center;
      background: var(--card);
      border-radius: 12px;
      padding: 14px; /* a bit tighter */
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.06);
      overflow: hidden;
      isolation: isolate;
    }

    /* LED ring along the border: thin glowing segment rotating around edges (slower + softer) */
    .led-ring{ position:absolute; inset:0; z-index:1; pointer-events:none; }
    .led-ring svg{ width:100%; height:100%; display:block; }
    .led-ring .faint{
      stroke: rgba(255,215,120,var(--led-faint));
      stroke-width: 1;
      filter: none;
    }
    .led-ring .dash{
      stroke: url(#glow);
      stroke-width: var(--led-width);
      stroke-linecap: round;
      stroke-dasharray: var(--led-on) var(--led-off);
      stroke-dashoffset: 0;
      animation: dash-rotate var(--led-speed) linear infinite;
      filter:
        drop-shadow(0 0 4px rgba(255,215,120, var(--led-ds1)))
        drop-shadow(0 0 10px rgba(255,215,120, var(--led-ds2)));
    }
    @keyframes dash-rotate{ to { stroke-dashoffset: -100; } }

    /* Images — block long-press/save */
    .mission img {
      width: 56px; height: 56px; margin-right: 14px; flex-shrink: 0; z-index: 2;
      -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; -webkit-user-drag: none;
      pointer-events: none;
      border-radius: 10px;
    }

    .mission-content { flex: 1; color: white; z-index: 2; }
    .mission-content h3 { margin: 0 0 6px; font-size: 17px; }
    .mission-content p  { margin: 0; font-size: 13px; color: var(--muted); }

    /* Progress bar */
    .progress-container {
      width: 100%; background: #444; border-radius: 10px; height: 12px; margin-top: 8px;
      overflow: hidden; position: relative;
    }
    .progress-bar {
      height: 12px; border-radius: 10px;
      background: linear-gradient(90deg, #ff2e2e 0%, orange 60%, #6fff00 100%);
      box-shadow: 0 0 10px 1px #fff700c7, 0 0 4px 1px #b6b000a4;
      position: relative; transition: width 0.5s cubic-bezier(.77,.2,.05,1.0);
      animation: progress_shine 2s linear infinite;
    }
    /* Gold theme for invite missions */
    .progress-bar.gold{
      background: linear-gradient(90deg, #a67c00 0%, #d4af37 40%, #ffd76a 70%, #a67c00 100%);
      box-shadow: 0 0 8px 1px rgba(212,175,55,.6), 0 0 3px 1px rgba(255,215,106,.5);
    }
    @keyframes progress_shine { 0%{filter:brightness(1)} 50%{filter:brightness(1.18)} 100%{filter:brightness(1)} }
    .progress-bar::after {
      content:""; position:absolute; top:0; left:0; height:100%; width:28px;
      background: linear-gradient(90deg, rgba(255,255,255,0.38) 10%, transparent 70%);
      opacity: .7; animation: progress_move 1.7s linear infinite;
    }
    @keyframes progress_move { 0%{left:0} 100%{left:calc(100% - 28px)} }

    /* Smaller action buttons (visit/follow/invite) */
    .mission button {
      padding: 8px 12px;                 /* smaller */
      background: var(--ok);
      color: #000;
      font-weight: 700;
      font-size: 13px;                   /* smaller */
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-left: 10px;
      z-index: 2;
      transition: transform .12s, filter .16s;
      min-width: 84px;                   /* smaller min width */
    }
    .mission button:hover { filter: brightness(1.05); }
    .mission button:active { transform: translateY(1px) scale(0.99); }
    .mission button:disabled {
      background: #c2c2c2; cursor: not-allowed; color: #555;
    }

    /* Modern modal */
    .modal {
      position: fixed; inset: 0; display: none; place-items: center; z-index: 9999;
      background: rgba(0,0,0,.56); backdrop-filter: blur(4px);
    }
    .modal.open { display: grid; }
    .modal-card{
      width: min(94vw, 420px);
      background: #0f1115;
      color: #eaf2ff;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 10px 30px rgba(0,0,0,.5);
      padding: 18px 16px 14px 16px;
      position: relative;
      overflow: hidden;
    }
    .modal-card h3{
      margin: 0 0 8px;
      font-size: 18px;
      background: linear-gradient(90deg, #fff, #dfe9ff);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .modal-card p{ margin: 6px 0; color: #cbd6f6; font-size: 14px; }
    .modal-actions{ margin-top: 12px; display: flex; gap: 8px; justify-content: center; }
    .btn{
      padding: 9px 14px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      color: #fff; font-weight: 800; letter-spacing: .2px; cursor: pointer;
      transition: transform .12s, filter .16s;
    }
    .btn.primary{ background: linear-gradient(180deg, #0a84ff, #0a6bff); }
    .btn.success{ background: linear-gradient(180deg, #17c964, #0b9d56); color:#001a10; }
    .btn.warning{ background: linear-gradient(180deg, #ffcc00, #f0b400); color:#2b1d00; }
    .btn:active{ transform: translateY(1px); }

    .close-x{
      position:absolute; top:8px; right:10px; width:26px; height:26px;
      display:grid; place-items:center; border-radius:8px; border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04)); color:#fff; cursor:pointer;
    }

    /* Confetti (visible over modal) */
    .confetti{
      position:absolute; inset:0; pointer-events:none; overflow:hidden; z-index: 2;
    }
    .confetti .piece{
      position:absolute; width:9px; height:14px; opacity:.98; border-radius:2px;
      will-change: transform, opacity;
      animation: confetti-fall 1200ms ease-out forwards;
    }
    @keyframes confetti-fall{
      0%  { transform: translate(var(--x0), -24px) rotate(var(--r0)); opacity:1; }
      100%{ transform: translate(var(--x1), var(--y1)) rotate(calc(var(--r0) + 540deg)); opacity:0; }
    }

    /* Global block: long press/context menu on images */
    img, svg { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; -webkit-user-drag: none; }
  </style>
</head>
<body>
  <button id="back-btn" aria-label="Back">
    <svg viewBox="0 0 24 24" fill="none"><path d="M15.5 19l-7-7 7-7" stroke="#111" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
  </button>

  <div class="header-box"><h1>You Can Do It</h1></div>
  <div id="missions"></div>

  <script>
    // Prevent image context / long-press
    (function preventMediaLongPress(){
      try{
        document.addEventListener('contextmenu', e=>{
          if (e.target && (e.target.tagName === 'IMG' || e.target.closest('img'))) e.preventDefault();
        }, true);
        ['touchstart','touchend','touchcancel','gesturestart'].forEach(ev=>{
          document.addEventListener(ev, (e)=>{
            const t = e.target;
            if (t && (t.tagName === 'IMG' || t.closest('img'))) e.preventDefault();
          }, {passive:false});
        });
      }catch{}
    })();

    // Telegram + Firebase init
    const tg = window.Telegram?.WebApp;
    try { tg && tg.ready(); } catch(e){}
    const firebaseConfig = {
      apiKey: "AIzaSyB9uNwUURvf5RsD7CnsG2LtE6fz5yboBkw",
      authDomain: "wellcoinbotgame.firebaseapp.com",
      databaseURL: "https://wellcoinbotgame-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "wellcoinbotgame",
      storageBucket: "wellcoinbotgame.appspot.com",
      messagingSenderId: "108640533638",
      appId: "1:108640533638:web:ed07516d96ac38f47f6507"
    };
    const app = (firebase.apps && firebase.apps.length) ? firebase.app() : firebase.initializeApp(firebaseConfig);
    const db  = firebase.database(app);

    // Cached preload: user id
    function getStoredUserId(){
      try{
        return sessionStorage.getItem('wlc_user_id') || localStorage.getItem('wlc_user_id') || tg?.initDataUnsafe?.user?.id || null;
      }catch{ return tg?.initDataUnsafe?.user?.id || null; }
    }
    const userId = String(getStoredUserId() || '');

    // Cache helpers (instant UI)
    const userCacheKey = uid => `wlc_cache_user_${uid}`;
    function readCachedUser(uid){
      try{ const raw = localStorage.getItem(userCacheKey(uid)); return raw ? JSON.parse(raw) : null; }catch{ return null; }
    }
    function writeCachedUser(uid, data){
      try{ localStorage.setItem(userCacheKey(uid), JSON.stringify(data)); }catch{}
    }

    // UI refs
    const backBtn = document.getElementById('back-btn');
    const missionsDiv = document.getElementById('missions');
    backBtn.addEventListener('click', (e)=>{ e.preventDefault(); history.back(); });

    // Utils
    function openSmart(url){
      try{
        let u = String(url||'').trim();
        if (!/^https?:\/\//i.test(u) && !/^tg:|^tme:|^mailto:/i.test(u)) {
          u = 'https://' + u.replace(/^\/+/, '');
        }
        if (/^https?:\/\/t\.me\/|^tg:|^tme:/i.test(u)){
          if (tg && typeof tg.openTelegramLink === 'function') tg.openTelegramLink(u);
          else window.open(u, '_blank');
        } else {
          if (tg && typeof tg.openLink === 'function') tg.openLink(u, { try_instant_view: false });
          else window.open(u, '_blank');
        }
      }catch{ window.open(url, '_blank'); }
    }
    async function getUserOnce(uid){
      const snap = await db.ref('users/'+uid).once('value');
      return snap.val() || {};
    }
    async function updateUser(uid, data){
      return db.ref('users/'+uid).update(data);
    }
    function txReferrals(uid, delta=1){
      const ref = db.ref('users/'+uid+'/referrals');
      return ref.transaction(v => (typeof v === 'number' ? v : Number(v||0)) + delta);
    }
    function markReferral(inviterId, newUid){
      return db.ref('referrals/'+inviterId+'/'+newUid).set(firebase.database.ServerValue.TIMESTAMP);
    }
    // balance helpers
    async function addWLC(uid, delta){
      const ref = db.ref('users/'+uid+'/balance');
      await ref.transaction(v => (typeof v === 'number' ? v : Number(v||0)) + Number(delta||0));
    }
    async function addUSDT(uid, delta){
      const ref = db.ref('users/'+uid+'/usdtBalance');
      await ref.transaction(v => (typeof v === 'number' ? v : Number(v||0)) + Number(delta||0));
    }

    // Modal helpers
    function showModal(contentNode){
      const m = document.createElement('div');
      m.className = 'modal open';
      const card = document.createElement('div');
      card.className = 'modal-card';
      const close = document.createElement('button');
      close.className = 'close-x';
      close.innerHTML = '✕';
      close.onclick = ()=> m.remove();
      card.appendChild(close);
      card.appendChild(contentNode);
      m.appendChild(card);
      document.body.appendChild(m);
      return { modal:m, card };
    }
    function makeConfirmVisitModal(title, body, yesLabel, onYes){
      const wrap = document.createElement('div');
      const h = document.createElement('h3'); h.textContent = title; wrap.appendChild(h);
      const p = document.createElement('p'); p.innerHTML = body; wrap.appendChild(p);
      const actions = document.createElement('div'); actions.className='modal-actions';
      const yes = document.createElement('button'); yes.className='btn success'; yes.textContent = yesLabel || 'Yes';
      const later = document.createElement('button'); later.className='btn'; later.textContent = 'Later';
      actions.appendChild(yes); actions.appendChild(later);
      wrap.appendChild(actions);
      const { modal } = showModal(wrap);
      later.onclick = ()=> modal.remove();
      yes.onclick = async()=>{ try{ await onYes?.(); } finally{ modal.remove(); } };
    }
    function makeInviteModal(link){
      const wrap = document.createElement('div');
      const h = document.createElement('h3'); h.textContent = 'Invite Friends'; wrap.appendChild(h);
      const p1 = document.createElement('p');
      p1.innerHTML = `<strong>Your referral link:</strong><br><span style="word-break:break-word;color:#fff">${link}</span>`;
      const p2 = document.createElement('p'); p2.style.color = '#ffb86b';
      p2.style.fontSize = '13px';
      p2.innerHTML = 'Warning: Fake referrals from the same device will be checked. Violations may lead to penalties.';
      wrap.appendChild(p1); wrap.appendChild(p2);
      const actions = document.createElement('div'); actions.className='modal-actions';
      const copy = document.createElement('button'); copy.className='btn warning'; copy.textContent = 'Copy';
      const share = document.createElement('button'); share.className='btn primary'; share.textContent = 'Share';
      actions.appendChild(share); actions.appendChild(copy);
      wrap.appendChild(actions);
      const { modal } = showModal(wrap);

      share.onclick = async ()=>{
        try{
          if (navigator.share){
            await navigator.share({ title:'WELLcoin', text:'Join WELLcoin game and earn with me!', url: link });
          }else if (tg && typeof tg.openTelegramLink === 'function'){
            const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent('Join WELLcoin game and earn with me!')}`;
            tg.openTelegramLink(shareUrl);
          }else{
            window.open(`https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent('Join WELLcoin game and earn with me!')}`,'_blank');
          }
        }catch{}
        modal.remove();
      };
      copy.onclick = ()=>{
        navigator.clipboard.writeText(link).then(()=>{ modal.remove(); });
      };
    }

    // Confetti overlay on the modal (high visibility)
    function fireConfetti(container){
      const c = document.createElement('div'); c.className='confetti';
      container.appendChild(c);
      const colors = ['#ff4757','#fffa65','#2ed573','#1e90ff','#eccc68','#ffa502','#7bed9f','#70a1ff','#ff6b81'];
      const rect = container.getBoundingClientRect();
      const pieces = 140;
      for (let i=0;i<pieces;i++){
        const piece = document.createElement('div'); piece.className='piece';
        piece.style.background = colors[(Math.random()*colors.length)|0];
        const x0 = (rect.width/2) + (Math.random()*90 - 45);
        const x1 = Math.random()*rect.width;
        const y1 = rect.height + 100 + Math.random()*120;
        const r0 = (Math.random()*180 - 90) + 'deg';
        piece.style.setProperty('--x0', x0+'px');
        piece.style.setProperty('--x1', x1+'px');
        piece.style.setProperty('--y1', y1+'px');
        piece.style.setProperty('--r0', r0);
        piece.style.left = '0px'; piece.style.top = '0px';
        piece.style.animationDuration = (1000 + Math.random()*800)+'ms';
        c.appendChild(piece);
        setTimeout(()=> piece.remove(), 2200);
      }
      setTimeout(()=> c.remove(), 2300);
    }
    function showCongratsModal(textHTML){
      const wrap = document.createElement('div');
      const h = document.createElement('h3'); h.textContent = 'Well done!'; wrap.appendChild(h);
      const p = document.createElement('p'); p.innerHTML = textHTML; wrap.appendChild(p);
      const actions = document.createElement('div'); actions.className='modal-actions';
      const ok = document.createElement('button'); ok.className='btn success'; ok.textContent = 'OK';
      actions.appendChild(ok); wrap.appendChild(actions);
      const { modal } = showModal(wrap);
      // confetti on the modal overlay (not clipped)
      fireConfetti(modal);
      ok.onclick = ()=> modal.remove();
    }

    // Render helpers
    function ledRingMarkup(){
      // SVG thin dash rotating around rounded rect (uses CSS vars for speed/softness)
      return `
        <div class="led-ring" aria-hidden="true">
          <svg viewBox="0 0 100 100" preserveAspectRatio="none">
            <defs>
              <linearGradient id="glow" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%"  stop-color="#fff2b0"/>
                <stop offset="100%" stop-color="#ffd76a"/>
              </linearGradient>
            </defs>
            <rect class="faint" x="1" y="1" width="98" height="98" rx="12" ry="12" fill="none" pathLength="100"></rect>
            <rect class="dash"  x="1" y="1" width="98" height="98" rx="12" ry="12" fill="none" pathLength="100"></rect>
          </svg>
        </div>
      `;
    }
    function renderMission({ id, title, desc, icon, reward, progress=null, claimed=false, disabled=false, buttonText="", onClick, progressTheme=null, extraClasses='' }){
      const div = document.createElement('div');
      div.className = `mission ${extraClasses||''}`;
      const progressHTML = (progress !== null) ? `
          <div class="progress-container">
            <div class="progress-bar ${progressTheme==='gold' ? 'gold':''}" style="width:${Math.max(0, Math.min(100, progress))}%"></div>
          </div>
          <p style="margin-top:4px; font-size:12px;">${Math.round(progress)}%</p>
        ` : '';
      div.innerHTML = `
        ${ledRingMarkup()}
        <img src="${icon}" alt="${title}" draggable="false" oncontextmenu="return false"/>
        <div class="mission-content">
          <h3>${title}</h3>
          <p>${desc}</p>
          ${progressHTML}
        </div>
        <button id="btn-${id}" ${disabled ? 'disabled' : ''}>${buttonText}</button>
      `;
      missionsDiv.appendChild(div);
      const btn = div.querySelector('#btn-'+id);
      if (btn) btn.onclick = onClick;
    }

    // Social tasks config (URLs normalized with https)
    const socials = [
      { id: "youtube",  title: "Follow us on YouTube",   icon: "assets/youtube-icon.png",   url: "https://www.youtube.com/@WELLcoin-y6b", reward: 1, type: "follow" },
      { id: "telegram", title: "Join our Telegram",      icon: "assets/telegram-icon.png",  url: "https://t.me/WELLcoinofficial",          reward: 1, type: "join"   },
      { id: "instagram",title: "Follow us on Instagram", icon: "assets/instagram-icon.png", url: "https://instagram.com/WELLcoin1",        reward: 1, type: "follow" },
      { id: "facebook", title: "Like our Facebook page", icon: "assets/facebook-icon.png",  url: "https://www.facebook.com/profile.php?id=61562283616319", reward: 1, type: "follow" },
      { id: "tiktok",   title: "Follow us on TikTok",    icon: "assets/tiktok-icon.png",    url: "https://www.tiktok.com/@wellcoin6?_t=ZN-8zBdro3gOQB&_r=1", reward: 1, type: "follow" },
      { id: "x",        title: "Follow us on X (Twitter)",icon:"assets/twitter-icon.png",   url: "https://x.com/WELLcoin2024?s=09",        reward: 1, type: "follow" }
    ];

    // Invite missions config — rewards in USDT as requested
    const inviteMissions = [
      { id: "invite5",   icon: "assets/invit1.png", label: "Invite 5 Friends",   target: 5,   rewardUSD: 0.2 },
      { id: "invite20",  icon: "assets/invit2.png", label: "Invite 20 Friends",  target: 20,  rewardUSD: 1 },
      { id: "invite100", icon: "assets/invit3.png", label: "Invite 100 Friends", target: 100, rewardUSD: 5 }
    ];

    // Preload images into memory cache
    (function preloadImages(){
      try{
        const urls = [
          ...socials.map(s=>s.icon),
          ...inviteMissions.map(i=>i.icon),
          "assets/daily-icon.png"
        ];
        urls.forEach(u => { const im = new Image(); im.decoding='async'; im.loading='eager'; im.src = u; });
      }catch{}
    })();

    // Referral: credit inviter if we have start_param and not yet credited
    let referralChecked = false;
    async function ensureReferralCredit(currentUser){
      if (referralChecked) return;
      referralChecked = true;
      try{
        const startParam = tg?.initDataUnsafe?.start_param || new URLSearchParams(location.search).get('ref');
        if (!startParam) return;
        const inviterId = String(startParam);
        if (!userId || !inviterId || inviterId === userId) return;

        const alreadyReferred = !!currentUser?.referredBy;
        if (alreadyReferred) return;

        await updateUser(userId, {
          referredBy: inviterId,
          referredAt: firebase.database.ServerValue.TIMESTAMP
        });
        await markReferral(inviterId, userId);
        await txReferrals(inviterId, +1);
      }catch(e){}
    }

    // Render
    function renderAll(user){
      missionsDiv.innerHTML = '';
      const userMissions = user.missions || {};
      const getClaimed = (id)=> !!(userMissions[id]?.claimed);

      // Social tasks (WLC rewards)
      socials.forEach(({id, title, icon, url, reward, type})=>{
        const isClaimed = getClaimed(id);
        renderMission({
          id,
          title,
          desc: `Reward: ${reward} WLC`,
          icon,
          reward,
          claimed: isClaimed,
          buttonText: isClaimed ? "Visit" : (type === "join" ? "Join Now" : "Follow"),
          disabled: false,
          onClick: async function(){
            openSmart(url);
            if (isClaimed) return;

            makeConfirmVisitModal(
              'Confirm Task',
              'Did you complete this task? You will receive <b>'+reward+' WLC</b>.',
              'Yes, I did',
              async ()=>{
                await addWLC(userId, reward);
                const updated = {
                  ...user,
                  balance: (Number(user.balance||0) + Number(reward||0)),
                  missions: { ...userMissions, [id]: { claimed: true } }
                };
                await updateUser(userId, { missions: updated.missions }); // balance updated via addWLC
                writeCachedUser(userId, updated);
                showCongratsModal(`You earned <b>${reward} WLC</b>!`);
                renderAll(updated);
              }
            );
          }
        });
      });

      // Daily reward (WLC)
      const dailyId = 'daily';
      const lastClaim = userMissions[dailyId]?.lastClaim || 0;
      const now = Date.now();
      const elapsed = now - Number(lastClaim || 0);
      const oneDay = 24*60*60*1000;
      const available = elapsed > oneDay;
      const remaining = Math.max(0, oneDay - elapsed);
      const dailyDesc = available ? "Claim your 1 WLC!" : `<span id="daily-timer">Time left: ${formatTime(remaining)}</span>`;

      renderMission({
        id: dailyId,
        title: "Daily Reward",
        desc: dailyDesc,
        icon: "assets/daily-icon.png",
        reward: 1,
        claimed: !available,
        disabled: !available,
        buttonText: "Claim",
        onClick: async function(){
          if (!available) return;
          await addWLC(userId, 1);
          const updated = { ...user, balance: Number(user.balance||0)+1, missions: { ...userMissions, [dailyId]: { lastClaim: Date.now() } } };
          await updateUser(userId, { missions: updated.missions }); // balance updated via addWLC
          writeCachedUser(userId, updated);
          showCongratsModal('You claimed <b>1 WLC</b> daily reward!');
          renderAll(updated);
        }
      });

      // Daily timer live update
      if (!available){
        let remain = remaining;
        const timerEl = document.getElementById('daily-timer');
        const intv = setInterval(()=>{
          remain -= 1000;
          if (remain <= 0){ clearInterval(intv); renderAll({ ...user, missions: { ...userMissions, [dailyId]: { lastClaim } } }); }
          else if (timerEl){ timerEl.textContent = 'Time left: ' + formatTime(remain); }
        }, 1000);
      }

      // Invites (USDT rewards)
      const refCountNum = (typeof user.referrals === 'number') ? user.referrals : Number(user.referrals||0);
      const inviteLink = `https://t.me/WELLcoinGameBot?startapp=${encodeURIComponent(userId)}`;

      inviteMissions.forEach(({id, label, icon, target, rewardUSD})=>{
        const achieved = refCountNum >= target;
        const alreadyClaimed = getClaimed(id);

        renderMission({
          id,
          title: label,
          desc: `Progress: ${refCountNum}/${target} – Reward: $${rewardUSD}`,
          icon,
          reward: rewardUSD,
          progress: Math.min((refCountNum/target)*100, 100),
          claimed: alreadyClaimed,
          disabled: alreadyClaimed,
          progressTheme: 'gold',
          extraClasses: 'invite',
          buttonText: alreadyClaimed ? "Claimed" : (achieved ? "Claim" : "Invite"),
          onClick: async function(){
            if (alreadyClaimed) return;

            if (!achieved){
              makeInviteModal(inviteLink);
              return;
            }

            // Claim USDT reward
            await addUSDT(userId, rewardUSD);
            const updated = {
              ...user,
              usdtBalance: Number(user.usdtBalance||0) + Number(rewardUSD||0),
              missions: { ...userMissions, [id]: { claimed: true, claimedAt: Date.now() } }
            };
            await updateUser(userId, { missions: updated.missions }); // usdt updated via addUSDT
            writeCachedUser(userId, updated);
            showCongratsModal(`You received <b>$${rewardUSD.toFixed(2)}</b> to your USDT balance!`);
            renderAll(updated);
          }
        });
      });
    }

    // Timer formatter
    function formatTime(ms){
      let sec = Math.max(0, Math.floor(ms/1000));
      let h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60), s=sec%60;
      return [h,m,s].map(x=>String(x).padStart(2,'0')).join(':');
    }

    // Subscribe live user + render from cache first
    async function boot(){
      if (!userId){ alert('Missing Telegram user. Please open from Telegram.'); return; }

      const cached = readCachedUser(userId);
      if (cached) renderAll(cached);

      const ref = db.ref('users/'+userId);
      let first = true;
      ref.on('value', async snap=>{
        const user = snap.val() || {};
        writeCachedUser(userId, user);
        if (first){
          first = false;
          ensureReferralCredit(user).catch(()=>{});
        }
        renderAll(user);
      }, err=>{
        console.error('DB error', err);
        if (!cached) missionsDiv.innerHTML = '<div style="opacity:.85">Error loading missions.</div>';
      });
    }

    window.addEventListener('load', boot);
  </script>
</body>
</html>
