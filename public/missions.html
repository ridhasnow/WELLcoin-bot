<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>Missions</title>

  <!-- Telegram + Firebase (compat) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <!-- Optional: warmup icons to render faster (browser cache) -->
  <link rel="preload" as="image" href="assets/youtube-icon.png"/>
  <link rel="preload" as="image" href="assets/telegram-icon.png"/>
  <link rel="preload" as="image" href="assets/instagram-icon.png"/>
  <link rel="preload" as="image" href="assets/facebook-icon.png"/>
  <link rel="preload" as="image" href="assets/tiktok-icon.png"/>
  <link rel="preload" as="image" href="assets/twitter-icon.png"/>
  <link rel="preload" as="image" href="assets/daily-icon.png"/>
  <link rel="preload" as="image" href="assets/invit1.png"/>
  <link rel="preload" as="image" href="assets/invit2.png"/>
  <link rel="preload" as="image" href="assets/invit3.png"/>

  <style>
    body {
      background: black;
      color: white;
      font-family: 'Segoe UI', system-ui, -apple-system, Roboto, Ubuntu, 'Helvetica Neue', Arial, sans-serif;
      padding: 20px;
      margin: 0;
      -webkit-text-size-adjust: 100%;
    }
    .header-box {
      background: #1a1a1a;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      margin-bottom: 30px;
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
    }
    .header-box h1 {
      font-size: 26px;
      color: white;
      background: linear-gradient(90deg, gold, white);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 0 6px rgba(255, 215, 0, 0.4);
      margin: 0;
    }

    /* Back button */
    #back-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      width: 32px;
      height: 32px;
      background: white;
      border: none;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.13);
      transition: background 0.18s;
      z-index: 1000;
      padding: 0;
    }
    #back-btn:hover { background: #f7f7f7; }
    #back-btn svg { width: 18px; height: 18px; display: block; }

    #missions { display: flex; flex-direction: column; gap: 20px; }
    .mission {
      display: flex;
      align-items: center;
      background: #2a2a2a;
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.1);
      position: relative;
      overflow: hidden;
    }

    /* Orange shine */
    .shiny-rect { position: absolute; inset: 0; z-index: 2; pointer-events: none; border-radius: 12px; overflow: hidden; }
    .shiny-rect .shine {
      position: absolute; top: 0; left: -60%; width: 70%; height: 100%;
      background: linear-gradient(110deg, transparent 40%, rgba(255,183,50,0.55) 55%, transparent 70%);
      opacity: 0.7; filter: blur(0.6px);
      animation: orange_shine_move 2.3s cubic-bezier(.72,0,.25,1) infinite;
    }
    @keyframes orange_shine_move { 0%{left:-60%} 100%{left:110%} }

    /* Images â€” block long-press/save */
    .mission img {
      width: 60px; height: 60px; margin-right: 16px; flex-shrink: 0; z-index: 2;
      -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; -webkit-user-drag: none;
      pointer-events: none;
    }

    .mission-content { flex: 1; color: white; z-index: 2; }
    .mission-content h3 { margin: 0 0 6px; font-size: 18px; }
    .mission-content p  { margin: 0; font-size: 14px; color: #ddd; }

    /* Progress bar */
    .progress-container {
      width: 100%; background: #444; border-radius: 10px; height: 12px; margin-top: 8px;
      overflow: hidden; position: relative;
    }
    .progress-bar {
      height: 12px; border-radius: 10px;
      background: linear-gradient(90deg, #ff2e2e 0%, orange 60%, #6fff00 100%);
      box-shadow: 0 0 10px 1px #fff700c7, 0 0 4px 1px #b6b000a4;
      position: relative; transition: width 0.5s cubic-bezier(.77,.2,.05,1.0);
      animation: progress_shine 2s linear infinite;
    }
    @keyframes progress_shine { 0%{filter:brightness(1)} 50%{filter:brightness(1.22)} 100%{filter:brightness(1)} }
    .progress-bar::after {
      content:""; position:absolute; top:0; left:0; height:100%; width:28px;
      background: linear-gradient(90deg, rgba(255,255,255,0.38) 10%, transparent 70%);
      opacity: .7; animation: progress_move 1.7s linear infinite;
    }
    @keyframes progress_move { 0%{left:0} 100%{left:calc(100% - 28px)} }

    button {
      padding: 10px 18px; background: #0f0; color: black; font-weight: bold; border: none; border-radius: 8px;
      cursor: pointer; margin-left: auto; z-index: 2; transition: background 0.16s; min-width: 92px;
    }
    button:disabled { background: #c2c2c2; cursor: not-allowed; color: #555; }

    /* Popup */
    .popup {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: #fff; padding: 24px 20px 18px 20px; border-radius: 16px;
      box-shadow: 0 0 25px rgba(255, 255, 255, 0.22); z-index: 9999; text-align: center; display: none;
      max-width: 94vw; min-width: 260px;
    }
    .popup p { color: black; margin-bottom: 15px; }
    .popup button { background: dodgerblue; color: white; padding: 10px 18px; border-radius: 8px; border: none; cursor: pointer; margin-top: 6px; margin-bottom: 2px; }
    .close-btn {
      position: absolute; top: 8px; right: 11px; font-size: 15px; background: transparent; border: none; color: #333;
      cursor: pointer; font-weight: bold; z-index: 33; opacity: .82; transition: opacity .15s; width: 22px; height: 22px;
      display: flex; align-items: center; justify-content: center; line-height: 1; padding: 0;
    }
    .close-btn:hover { opacity: 1; }

    /* Global block: long press/context menu */
    img, svg { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; -webkit-user-drag: none; }
  </style>
</head>
<body>
  <button id="back-btn" aria-label="Back">
    <svg viewBox="0 0 24 24" fill="none"><path d="M15.5 19l-7-7 7-7" stroke="#111" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
  </button>

  <div class="header-box"><h1>You Can Do It</h1></div>
  <div id="missions"></div>

  <script>
    // Prevent context menu / long-press
    (function preventMediaLongPress(){
      try{
        document.addEventListener('contextmenu', e=>{
          if (e.target && (e.target.tagName === 'IMG' || e.target.closest('img'))) e.preventDefault();
        }, true);
        ['touchstart','touchend','touchcancel','gesturestart'].forEach(ev=>{
          document.addEventListener(ev, (e)=>{
            const t = e.target;
            if (t && (t.tagName === 'IMG' || t.closest('img'))) e.preventDefault();
          }, {passive:false});
        });
      }catch{}
    })();

    // Telegram + Firebase init
    const tg = window.Telegram?.WebApp;
    try { tg && tg.ready(); } catch(e){}
    const firebaseConfig = {
      apiKey: "AIzaSyB9uNwUURvf5RsD7CnsG2LtE6fz5yboBkw",
      authDomain: "wellcoinbotgame.firebaseapp.com",
      databaseURL: "https://wellcoinbotgame-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "wellcoinbotgame",
      storageBucket: "wellcoinbotgame.appspot.com",
      messagingSenderId: "108640533638",
      appId: "1:108640533638:web:ed07516d96ac38f47f6507"
    };
    const app = (firebase.apps && firebase.apps.length) ? firebase.app() : firebase.initializeApp(firebaseConfig);
    const db  = firebase.database(app);

    // Cached preload: user id from preload
    function getStoredUserId(){
      try{
        return sessionStorage.getItem('wlc_user_id') || localStorage.getItem('wlc_user_id') || tg?.initDataUnsafe?.user?.id || null;
      }catch{ return tg?.initDataUnsafe?.user?.id || null; }
    }
    const userId = String(getStoredUserId() || '');

    // Cache helpers (instant UI)
    const userCacheKey = uid => `wlc_cache_user_${uid}`;
    function readCachedUser(uid){
      try{ const raw = localStorage.getItem(userCacheKey(uid)); return raw ? JSON.parse(raw) : null; }catch{ return null; }
    }
    function writeCachedUser(uid, data){
      try{ localStorage.setItem(userCacheKey(uid), JSON.stringify(data)); }catch{}
    }

    // UI refs
    const backBtn = document.getElementById('back-btn');
    const missionsDiv = document.getElementById('missions');
    backBtn.addEventListener('click', (e)=>{ e.preventDefault(); history.back(); });

    // Utils
    async function getUserOnce(uid){
      const snap = await db.ref('users/'+uid).once('value');
      return snap.val() || {};
    }
    async function updateUser(uid, data){
      return db.ref('users/'+uid).update(data);
    }
    function txReferrals(uid, delta=1){
      const ref = db.ref('users/'+uid+'/referrals');
      return ref.transaction(v => (typeof v === 'number' ? v : Number(v||0)) + delta);
    }
    // Record a unique referral in a list to avoid double counting
    function markReferral(inviterId, newUid){
      return db.ref('referrals/'+inviterId+'/'+newUid).set(firebase.database.ServerValue.TIMESTAMP);
    }

    // Render helpers
    function createCloseBtn(popup){
      const btn = document.createElement('button');
      btn.className = 'close-btn';
      btn.innerHTML = '&times;';
      btn.onclick = ()=> popup.remove();
      return btn;
    }
    function formatTime(ms){
      let sec = Math.max(0, Math.floor(ms/1000));
      let h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60), s=sec%60;
      return [h,m,s].map(x=>String(x).padStart(2,'0')).join(':');
    }

    function renderMission({ id, title, desc, icon, reward, progress=null, claimed=false, disabled=false, buttonText="", onClick }){
      const div = document.createElement('div');
      div.className = 'mission';
      let progressHTML = '';
      if (progress !== null){
        progressHTML = `
          <div class="progress-container">
            <div class="progress-bar" style="width:${Math.max(0, Math.min(100, progress))}%"></div>
          </div>
          <p style="margin-top:4px; font-size:12px;">${Math.round(progress)}%</p>
        `;
      }
      div.innerHTML = `
        <div class="shiny-rect"><div class="shine"></div></div>
        <img src="${icon}" alt="${title}" draggable="false" oncontextmenu="return false"/>
        <div class="mission-content">
          <h3>${title}</h3>
          <p>${desc}</p>
          ${progressHTML}
        </div>
        <button id="btn-${id}" ${disabled ? 'disabled' : ''}>${buttonText}</button>
      `;
      missionsDiv.appendChild(div);
      const btn = div.querySelector('#btn-'+id);
      if (btn) btn.onclick = onClick;
    }

    // Social tasks config
    const socials = [
      { id: "youtube",  title: "Follow us on YouTube",  icon: "assets/youtube-icon.png",  url: "https://www.youtube.com/@WELLcoin-y6b", reward: 1, type: "follow" },
      { id: "telegram", title: "Join our Telegram",     icon: "assets/telegram-icon.png", url: "https://t.me/WELLcoinofficial",         reward: 1, type: "join"   },
      { id: "instagram",title: "Follow us on Instagram",icon: "assets/instagram-icon.png",url: "https://instagram.com/WELLcoin1",        reward: 1, type: "follow" },
      { id: "facebook", title: "Like our Facebook page",icon: "assets/facebook-icon.png", url: "https://www.facebook.com/profile.php?id=61562283616319", reward: 1, type: "follow" },
      { id: "tiktok",   title: "Follow us on TikTok",   icon: "assets/tiktok-icon.png",   url: "https://tiktok.com/@WELLcoin6",          reward: 1, type: "follow" },
      { id: "x",        title: "Follow us on X (Twitter)",icon:"assets/twitter-icon.png", url: "https://x.com/WELLcoin2024?s=09",        reward: 1, type: "follow" }
    ];

    // Invite missions config
    const inviteMissions = [
      { id: "invite5",   icon: "assets/invit1.png", label: "Invite 5 Friends",   target: 5,   reward: 0.5 },
      { id: "invite20",  icon: "assets/invit2.png", label: "Invite 20 Friends",  target: 20,  reward: 2   },
      { id: "invite100", icon: "assets/invit3.png", label: "Invite 100 Friends", target: 100, reward: 10  }
    ];

    // Preload images into memory cache (faster first paint)
    (function preloadImages(){
      try{
        const urls = [
          ...socials.map(s=>s.icon),
          ...inviteMissions.map(i=>i.icon),
          "assets/daily-icon.png"
        ];
        urls.forEach(u => { const im = new Image(); im.decoding='async'; im.loading='eager'; im.src = u; });
      }catch{}
    })();

    // Referral: credit inviter if we have start_param and not yet credited
    let referralChecked = false;
    async function ensureReferralCredit(currentUser){
      if (referralChecked) return;
      referralChecked = true;
      try{
        const startParam = tg?.initDataUnsafe?.start_param || new URLSearchParams(location.search).get('ref');
        if (!startParam) return;
        const inviterId = String(startParam);
        if (!userId || !inviterId || inviterId === userId) return;

        const alreadyReferred = !!currentUser?.referredBy;
        if (alreadyReferred) return;

        // Mark user as referred, then count for inviter (idempotent-ish)
        await updateUser(userId, {
          referredBy: inviterId,
          referredAt: firebase.database.ServerValue.TIMESTAMP
        });
        await markReferral(inviterId, userId);
        await txReferrals(inviterId, +1);
      }catch(e){ /* silent */ }
    }

    // Render all missions from a user snapshot (cached or live)
    function renderAll(user){
      missionsDiv.innerHTML = '';
      const userMissions = user.missions || {};
      const getClaimed = (id)=> !!(userMissions[id]?.claimed);

      // Social tasks
      socials.forEach(({id, title, icon, url, reward, type})=>{
        const isClaimed = getClaimed(id);
        renderMission({
          id,
          title,
          desc: `Reward: ${reward} WLC`,
          icon,
          reward,
          claimed: isClaimed,
          buttonText: isClaimed ? "Visit" : (type === "join" ? "Join Now" : "Follow"),
          disabled: false,
          onClick: async function(){
            try{
              const open = (lnk)=>{
                if (tg && typeof tg.openTelegramLink === 'function') tg.openTelegramLink(lnk);
                else window.open(lnk, "_blank");
              };
              open(url);
              if (isClaimed) return;

              // Confirm popup
              setTimeout(()=>{
                const popup = document.createElement('div');
                popup.className = 'popup';
                popup.innerHTML = `
                  <p>Did you complete this task?</p>
                  <p style="font-size:13px; color:#444;">If you unfollow later, the reward may be deducted.</p>
                  <button id="yes-${id}">Yes, done</button>
                `;
                popup.appendChild(createCloseBtn(popup));
                document.body.appendChild(popup);
                popup.style.display = 'block';
                document.getElementById(`yes-${id}`).onclick = async ()=>{
                  const newBalance = Number(user.balance||0) + Number(reward||0);
                  await updateUser(userId, {
                    balance: newBalance,
                    missions: { ...userMissions, [id]: { claimed: true } }
                  });
                  popup.remove();
                  // Update cache locally for instant UI
                  const updated = { ...user, balance: newBalance, missions: { ...userMissions, [id]: { claimed: true } } };
                  writeCachedUser(userId, updated);
                  renderAll(updated);
                };
              }, 700);
            }catch(e){}
          }
        });
      });

      // Daily reward
      const dailyId = 'daily';
      const lastClaim = userMissions[dailyId]?.lastClaim || 0;
      const now = Date.now();
      const elapsed = now - Number(lastClaim || 0);
      const oneDay = 24*60*60*1000;
      const available = elapsed > oneDay;
      const remaining = Math.max(0, oneDay - elapsed);
      const dailyDesc = available ? "Claim your 1 WLC!" : `<span id="daily-timer">Time left: ${formatTime(remaining)}</span>`;

      renderMission({
        id: dailyId,
        title: "Daily Reward",
        desc: dailyDesc,
        icon: "assets/daily-icon.png",
        reward: 1,
        claimed: !available,
        disabled: !available,
        buttonText: "Claim",
        onClick: async function(){
          if (!available) return;
          const newBalance = Number(user.balance||0) + 1;
          const updatedMissions = { ...userMissions, [dailyId]: { lastClaim: Date.now() } };
          await updateUser(userId, { balance: newBalance, missions: updatedMissions });
          const updated = { ...user, balance: newBalance, missions: updatedMissions };
          writeCachedUser(userId, updated);
          renderAll(updated);
        }
      });

      // Daily timer live update
      if (!available){
        let remain = remaining;
        const timerEl = document.getElementById('daily-timer');
        const intv = setInterval(()=>{
          remain -= 1000;
          if (remain <= 0){ clearInterval(intv); renderAll({ ...user, missions: { ...userMissions, [dailyId]: { lastClaim } } }); }
          else if (timerEl){ timerEl.textContent = 'Time left: ' + formatTime(remain); }
        }, 1000);
      }

      // Invite missions
      const refCountNum = (typeof user.referrals === 'number') ? user.referrals : Number(user.referrals||0);
      const inviteLink = `https://t.me/WELLcoinGameBot?startapp=${encodeURIComponent(userId)}`;
      inviteMissions.forEach(({id, label, icon, target, reward})=>{
        const achieved = refCountNum >= target;
        const alreadyClaimed = getClaimed(id);

        renderMission({
          id,
          title: label,
          desc: `Progress: ${refCountNum}/${target} â€“ Reward: ${reward} WLC`,
          icon,
          reward,
          progress: Math.min((refCountNum/target)*100, 100),
          claimed: alreadyClaimed,
          disabled: alreadyClaimed,
          buttonText: alreadyClaimed ? "Claimed" : (achieved ? "Claim" : "Invite"),
          onClick: async function(){
            if (alreadyClaimed) return;

            if (!achieved){
              // Show share/copy popup with proper Telegram deep link that carries start_param to WebApp
              const popup = document.createElement('div');
              popup.className = 'popup';
              popup.innerHTML = `
                <p>Your Invite Link</p>
                <p style="word-break:break-word; color:#111">${inviteLink}</p>
                <div style="display:flex; gap:8px; justify-content:center;">
                  <button id="copy-${id}" style="background:#0a84ff">Copy</button>
                  <button id="share-${id}" style="background:#34c759">Share</button>
                </div>
              `;
              popup.appendChild(createCloseBtn(popup));
              document.body.appendChild(popup);
              popup.style.display = 'block';
              document.getElementById(`copy-${id}`).onclick = ()=>{
                navigator.clipboard.writeText(inviteLink).then(()=>{
                  popup.remove();
                });
              };
              document.getElementById(`share-${id}`).onclick = ()=>{
                const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(inviteLink)}&text=${encodeURIComponent('Join WELLcoin game and earn with me!')}`;
                if (tg && typeof tg.openTelegramLink === 'function') tg.openTelegramLink(shareUrl); else window.open(shareUrl,'_blank');
                popup.remove();
              };
              return;
            }

            // Achieved: claim once
            const newBalance = Number(user.balance||0) + Number(reward||0);
            const updatedMissions = { ...userMissions, [id]: { claimed: true, claimedAt: Date.now() } };
            await updateUser(userId, { balance: newBalance, missions: updatedMissions });
            const updated = { ...user, balance: newBalance, missions: updatedMissions };
            writeCachedUser(userId, updated);

            const popup = document.createElement('div');
            popup.className = 'popup';
            popup.innerHTML = `
              <p>ðŸŽ‰ +${reward} WLC</p>
              <p style="font-size:13px; color:#444;">Great job! Keep inviting to unlock more.</p>
              <button id="ok-${id}">OK</button>
            `;
            popup.appendChild(createCloseBtn(popup));
            document.body.appendChild(popup);
            popup.style.display = 'block';
            document.getElementById(`ok-${id}`).onclick = ()=>{ popup.remove(); renderAll(updated); };
          }
        });
      });
    }

    // Subscribe live user + cache, render instantly from cache first
    async function boot(){
      if (!userId){ alert('Missing Telegram user. Please open from Telegram.'); return; }

      const cached = readCachedUser(userId);
      if (cached) renderAll(cached);

      // Live stream
      const ref = db.ref('users/'+userId);
      let first = true;
      ref.on('value', async snap=>{
        const user = snap.val() || {};
        writeCachedUser(userId, user);
        if (first){
          first = false;
          // credit referral on first live snapshot if needed
          ensureReferralCredit(user).catch(()=>{});
        }
        renderAll(user);
      }, err=>{
        console.error('DB error', err);
        if (!cached) missionsDiv.innerHTML = '<div style="opacity:.85">Error loading missions.</div>';
      });
      // Back button sound state preservation (if you used preload audio)
      backBtn.addEventListener('click', (e)=>{
        e.preventDefault();
        try{
          const a = document.getElementById('preloadAudio');
          if (a){
            sessionStorage.setItem('wlc_music_ct', String(a.currentTime||0));
            sessionStorage.setItem('wlc_music_track','assets/preload.mp3');
            if (!sessionStorage.getItem('wlc_music_started_at_ms')){
              sessionStorage.setItem('wlc_music_started_at_ms', String(Date.now() - (a.currentTime || 0) * 1000));
            }
          }
        }catch{}
        history.back();
      });
    }

    window.addEventListener('load', boot);
  </script>
</body>
</html>
