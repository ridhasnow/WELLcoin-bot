<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Me</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="color-scheme" content="dark">
  <style>
    :root{
      --bg:#05070b;
      --glass:rgba(250,230,170,0.10);
      --glass-2:rgba(250,235,190,0.08);
      --glass-border:rgba(255,228,150,0.28);
      --text:#eef3ff;
      --muted:#b9c3d9;

      --gold:#ffd36a; --gold-2:#ffe9a8;
      --green:#39e58a; --green-2:#9dffd0;
      --blue:#70a0ff; --danger:#ff6b6b;

      --shadow-1:0 12px 40px rgba(0,0,0,.55);
      --shadow-2:0 6px 18px rgba(0,0,0,.40);

      --r-lg:22px; --r-md:14px; --r-sm:10px;
      --t-fast:.12s ease-out; --t-med:.18s ease-out;
    }

    html,body{height:100%}
    body{
      margin:0; background:transparent; color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
      overflow:hidden;
    }

    /* Ambient (kept, but card fills screen so this is subtle) */
    .glow{
      position:fixed; inset:0; z-index:0; pointer-events:none;
      background:
        radial-gradient(60vw 60vw at 18% 18%, rgba(120,255,160,0.08), transparent 70%),
        radial-gradient(50vw 50vw at 82% 22%, rgba(255,240,140,0.06), transparent 70%),
        radial-gradient(70vw 70vw at 50% 86%, rgba(90,180,255,0.07), transparent 70%);
      filter: blur(8px) saturate(110%);
    }
    .wrap{
      position:relative; z-index:1; width:100%; height:100%;
      display:flex; align-items:stretch; justify-content:center;
      padding: 0;
    }

    /* Full-screen glass page, slightly left by 2px, rounded corners */
    .card{
      width:100vw;
      height:100vh;
      background:
        linear-gradient(180deg, var(--glass), var(--glass-2)),
        linear-gradient(180deg, rgba(30,36,50,0.30), rgba(18,22,30,0.36));
      border-radius: var(--r-lg);
      border: 1px solid var(--glass-border);
      box-shadow: var(--shadow-1);
      backdrop-filter: blur(12px) saturate(130%);
      position:relative; overflow:hidden; display:flex; flex-direction:column;
      margin: 0;
      transform: translateX(-2px);
    }
    .card::before{
      content:""; position:absolute; inset:0; border-radius: var(--r-lg);
      padding:1px; background:
        linear-gradient(135deg, rgba(255,230,150,.35), rgba(120,190,255,.22), rgba(80,255,170,.25));
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude; pointer-events:none; opacity:.9;
    }

    /* Topbar */
    .topbar{
      position:absolute; inset:0 0 auto 0; height:56px;
      display:flex; align-items:center; justify-content:space-between;
      padding: max(10px, env(safe-area-inset-top)) 12px 10px 12px; z-index:2;
    }
    .icon-btn{
      width:38px; height:38px; border-radius:12px;
      display:flex; align-items:center; justify-content:center;
      background: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.04));
      border: 1px solid rgba(255,255,255,0.12);
      color:#fff; cursor:pointer; user-select:none;
      transition: transform var(--t-fast), background var(--t-med), border-color var(--t-med);
      box-shadow: var(--shadow-2); backdrop-filter: blur(6px);
    }
    .icon-btn:hover{ background: rgba(255,255,255,0.12); border-color: rgba(255,255,255,0.2); }
    .icon-btn:active{ transform: scale(.97); }
    .icon-btn svg{ width:18px; height:18px; fill:#eaf2ff; opacity:.95 }

    .scroll{ flex:1; overflow:auto; -webkit-overflow-scrolling:touch; padding: 62px 16px max(18px, env(safe-area-inset-bottom)) 16px; }

    /* Profile */
    .profile{
      display:flex; flex-direction:column; align-items:center; gap:12px; text-align:center;
    }

    /* Rank area (badge + progress) */
    .ranked{
      width:100%; display:flex; flex-direction:column; align-items:center; gap:12px;
    }
    .rank-name{
      font-weight:900; letter-spacing:.3px; font-size:1.06rem;
      background: linear-gradient(90deg, #e6f1ff, #fff);
      -webkit-background-clip: text; background-clip:text; color: transparent;
      text-shadow: 0 1px 2px rgba(0,0,0,.35);
    }
    .rank-badge-wrap{
      position:relative; width:140px; height:140px; display:grid; place-items:center;
      filter:saturate(115%);
    }
    .rank-badge{
      width:120px; height:120px; object-fit:contain;
      image-rendering: -webkit-optimize-contrast;
      filter: drop-shadow(0 0 16px rgba(120,200,255,.36)) drop-shadow(0 8px 22px rgba(0,0,0,.55));
      z-index:1; pointer-events:none; user-select:none;
    }
    .rank-badge-wrap::after{
      content:""; position:absolute; inset:6px; border-radius:18px;
      background: radial-gradient(70% 70% at 50% 50%, rgba(120,200,255,.20), rgba(0,0,0,0));
      filter: blur(6px);
    }

    .rank-progress{
      width:min(92%, 460px); display:flex; flex-direction:column; gap:8px; align-items:stretch;
    }
    .progress-bar{
      height:14px; border-radius:999px; overflow:hidden; position:relative;
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: inset 0 2px 6px rgba(0,0,0,.35), 0 6px 18px rgba(0,0,0,.30);
    }
    .progress-bar .fill{
      height:100%; width:0%; border-radius:999px;
      background: linear-gradient(90deg, #45e27f, #9dffd0);
      box-shadow: 0 0 14px rgba(60,220,130,.35);
      transition: width .35s ease;
    }
    .progress-meta{
      display:flex; align-items:center; justify-content:center; gap:8px;
      font-weight:900; letter-spacing:.25px; color:#dff7ea;
      text-shadow: 0 1px 2px rgba(0,0,0,.35);
    }
    .progress-meta .up{
      width:14px; height:14px; display:inline-block;
      filter: drop-shadow(0 0 6px rgba(80,255,160,.55));
    }
    .next-need{
      font-size:.88rem; color:#cfe0ff; text-align:center; opacity:.95;
    }

    .namebox{
      display:inline-flex; flex-direction:column; gap:4px; align-items:center;
      padding:10px 16px; border-radius: 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.12); box-shadow: inset 0 1px 0 rgba(255,255,255,.10);
      min-width: 62%;
    }
    .nickname{
      font-weight:900; letter-spacing:.2px; font-size:1.15rem;
      background: linear-gradient(90deg, #fff, #dfe9ff);
      -webkit-background-clip: text; background-clip:text; color: transparent;
      text-shadow: 0 1px 2px rgba(0,0,0,.35);
    }

    /* Balances */
    .balances{ margin-top:14px; display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 420px){ .balances{ grid-template-columns: 1fr; } }
    .bal{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border:1px solid rgba(255,255,255,.14);
      border-radius: var(--r-md); padding: 12px; box-shadow: var(--shadow-2);
      display:flex; flex-direction:column; gap:10px;
    }
    .bal-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .bal-id{ display:flex; align-items:center; gap:8px; font-weight:800; letter-spacing:.3px; color:#eef3ff; }
    .bal-id img{ width:18px; height:18px; object-fit:contain; }
    .bal-amt{
      display:flex; align-items:baseline; gap:6px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-weight:900; letter-spacing:.3px; text-shadow: 0 0 10px rgba(255,255,255,.06);
    }
    .bal-wlc .bal-amt{ color: var(--gold); }
    .bal-usdt .bal-amt{ color: var(--green); }
    .bal-cta{ align-self:flex-start; border:none; border-radius: 10px; padding:8px 13px; font-weight:900; cursor:pointer;
      transition: transform var(--t-fast), box-shadow var(--t-med), filter var(--t-fast);
    }
    .bal-cta:active{ transform: translateY(1px) scale(0.99); }
    .bal-cta.wlc{ background: linear-gradient(90deg, var(--gold), var(--gold-2)); color:#222; box-shadow: 0 6px 16px rgba(255, 210, 90, .30); }
    .bal-cta.usdt{ background: linear-gradient(90deg, var(--green), var(--green-2)); color:#0d2418; box-shadow: 0 6px 16px rgba(60, 220, 130, .28); }

    .section-title{
      margin: 18px 2px 10px 4px; font-weight:900; letter-spacing:.3px; font-size:1.02rem; color:#e9f1ff;
      display:flex; align-items:center; gap:8px;
    }
    .section-title::before{
      content:""; width:8px; height:8px; border-radius:999px;
      background: radial-gradient(circle, #ffd36a, #8affc2);
      box-shadow: 0 0 10px rgba(255,211,106,.45);
    }

    /* Achievements grid - 5 per row */
    .ach{
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap:12px;
    }
    @media (max-width: 360px){
      .ach{ gap:10px; }
    }

    /* Day card - tuned, image shows fully; timer below card */
    .day{
      position:relative; border-radius:14px;
      overflow:visible; user-select:none;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 6px 18px rgba(0,0,0,.40);
      display:flex; flex-direction:column;
      aspect-ratio: 1 / 1.18;
      margin-bottom: 38px; /* space for timer below */
      transition: filter .25s ease;
    }
    .day.special{
      border-color: rgba(255,210,90,.45);
      box-shadow: 0 10px 24px rgba(255,210,90,.20), inset 0 0 0 1px rgba(255,255,255,.06);
    }

    /* Cap (header) */
    .cap{
      position:relative; height: clamp(26px, 6.8vw, 34px);
      display:flex; align-items:center; justify-content:center;
      background: linear-gradient(180deg, #5aa4ff, #3385ff);
      color:#eaf3ff; font-weight:900; letter-spacing:.3px; text-shadow: 0 1px 2px rgba(0,0,0,.35);
      border-bottom: 1px solid rgba(0,0,0,.25);
      font-size: clamp(12px, 3.2vw, 15px);
      border-top-left-radius: 14px; border-top-right-radius: 14px;
    }
    .day.special .cap{
      background: linear-gradient(180deg, #ffcb5a, #ffad33);
      color:#2a1a00; text-shadow: 0 1px 1px rgba(255,255,255,.35);
    }
    .cap .pin{ position:absolute; top:-6px; width:10px; height:10px; border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #fff, #bcd, #566); box-shadow: 0 1px 2px rgba(0,0,0,.5);
    }
    .cap .pin.l{ left:10px; } .cap .pin.r{ right:10px; }

    /* Body holds the image with BLACK background (no gaps), image stays fully visible */
    .body{
      position:relative; flex:1;
      display:block;
      padding:0;
      background: #000; /* requested black base to match gift.png edges */
      border-bottom-left-radius: 14px; border-bottom-right-radius: 14px;
      overflow:hidden;
    }
    .gift-img{
      position:absolute; inset:0; z-index:1;
      width:100%; height:100%;
      object-fit: contain; /* keep entire image visible */
      filter: saturate(112%) contrast(103%) drop-shadow(0 4px 8px rgba(0,0,0,.25));
      pointer-events:none; user-select:none; -webkit-user-drag:none;
    }

    /* Timer BELOW the card, single line (no 'In') */
    .timer{
      position:absolute; left:0; right:0; bottom:-24px;
      font-size:12px; font-weight:900; color:#d3ddff; opacity:.98; text-align:center;
      text-shadow: 0 1px 2px rgba(0,0,0,.5); pointer-events:none; white-space:nowrap;
    }

    /* States */
    .day.locked{ filter: brightness(.96) saturate(.95); }
    .day.claimable{
      border-color: rgba(255,210,90,.55);
      box-shadow: 0 10px 24px rgba(255,210,90,.22), inset 0 0 0 1px rgba(255,255,255,.05);
      animation: pulse 1.4s ease-in-out infinite alternate;
    }
    .day.claimed{
      filter: brightness(.60) saturate(.9); /* dim after claim */
    }
    @keyframes pulse{ from{ filter:none } to{ filter: drop-shadow(0 0 8px rgba(255,220,100,.36)); } }

    /* Claimed overlay (modern check) - ABOVE image and slightly lower (middle of lower half) */
    .check{
      position:absolute; inset:0; display:grid; place-items:center; pointer-events:none;
      opacity:0; transform: translate(-2px, 18%) scale(.9); transition: opacity .2s ease, transform .2s ease;
      z-index:3; /* above gift image */
    }
    .day.claimed .check{ opacity:1; transform: translate(-2px, 18%) scale(1); }
    .check .mark{ width:76px; height:76px; }
    .check svg{ width:100%; height:100%; }

    .spacer{ height:14px; }
    * { -webkit-tap-highlight-color: rgba(0,0,0,0); }

    /* Popup (Top-up/Claim confirmation) */
    .mask{
      position:fixed; inset:0; z-index:20; display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,0.45); backdrop-filter: blur(4px) saturate(120%);
    }
    .pop{
      width:min(92vw, 460px);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.18);
      border-radius:18px; padding:18px 16px; box-shadow: 0 14px 40px rgba(0,0,0,.55);
      text-align:center; color:#eef3ff; position:relative; overflow:hidden;
    }
    .pop h3{ margin:6px 0 6px; font-size:1.2rem; letter-spacing:.3px; }
    .pop .desc{ margin:6px 0 10px; color:#d5e1ff; }
    .pop .reward{
      margin:10px auto 14px; font-weight:900; letter-spacing:.5px;
      color:#45e27f; text-shadow: 0 1px 2px rgba(0,0,0,.45);
    }
    .pop .ok{
      border:none; border-radius:12px; padding:10px 18px; cursor:pointer;
      background: linear-gradient(90deg, #45e27f, #9dffd0); color:#0b2117;
      font-weight:900; letter-spacing:.3px; box-shadow: 0 8px 22px rgba(60,220,130,.35);
      transition: transform var(--t-fast), filter var(--t-fast);
    }
    .pop .ok:active{ transform: translateY(1px) scale(0.99); }

    /* Confetti canvas */
    .confetti{
      position:fixed; inset:0; z-index:22; pointer-events:none;
    }

    /* Gate overlay */
    .gate{
      position:fixed; inset:0; z-index:50; display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,.85);
      color:#ffe9a8; font-weight:900; letter-spacing:.3px; text-align:center; padding:24px;
    }

    /* Divider between Achievements and Daily tasks (3D line/shadow) */
    .divider{
      position:relative; height:18px; margin: 8px 2px 2px;
    }
    .divider::before{
      content:""; position:absolute; left:6px; right:6px; top:50%; height:2px; transform: translateY(-50%);
      background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,.30) 18%, rgba(255,220,120,.65) 50%, rgba(255,255,255,.30) 82%, transparent 100%);
      box-shadow: 0 2px 6px rgba(0,0,0,.45), 0 0 18px rgba(255,210,90,.35);
      border-radius: 999px;
    }

    /* Daily tasks button + modal - Enhanced electric 3D */
    .tasks-cta{ display:flex; align-items:center; justify-content:center; padding:8px 0 2px; }
    .btn-earn{
      position:relative; isolation:isolate; cursor:pointer; user-select:none;
      border:none; border-radius: 16px; padding:16px 26px;
      color:#231a00; font-weight:900; letter-spacing:.45px; font-size:1.02rem;
      background: linear-gradient(180deg, #ffe28f, #ffd36a 55%, #ffbe3a);
      box-shadow:
        inset 0 2px 0 rgba(255,255,255,.45),
        inset 0 -2px 0 rgba(170,110,10,.25),
        0 14px 28px rgba(255,200,80,.35),
        0 4px 0 rgba(150,100,10,.35);
      overflow:hidden;
      transform-style: preserve-3d;
    }
    /* sweeping highlight */
    .btn-earn::before{
      content:""; position:absolute; inset:-130% -30%; z-index:0;
      background:
        radial-gradient(22px 8px at 10% 40%, rgba(255,255,255,.85), transparent 60%),
        radial-gradient(28px 10px at 30% 60%, rgba(255,255,255,.65), transparent 60%),
        linear-gradient(120deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.85) 35%, rgba(255,255,255,0) 70%);
      transform: rotate(10deg);
      animation: electric 2s linear infinite;
      mix-blend-mode: screen; opacity:.85;
      pointer-events:none;
    }
    /* inner glow and rim */
    .btn-earn::after{
      content:""; position:absolute; inset:0; border-radius:16px; z-index:1; pointer-events:none;
      box-shadow:
        inset 0 0 18px rgba(255,255,255,.25),
        inset 0 0 36px rgba(255,210,80,.25);
    }
    /* electric arcs overlay using span pseudo */
    .btn-earn span{ position:relative; z-index:2; text-shadow: 0 1px 0 rgba(255,255,255,.6); }
    .btn-earn span::before{
      content:""; position:absolute; inset:-10px; z-index:-1; border-radius:14px;
      background:
        repeating-radial-gradient(circle at 30% 50%, rgba(255,255,255,.8) 0 1px, rgba(255,255,255,0) 2px 10px),
        repeating-radial-gradient(circle at 70% 40%, rgba(255,240,160,.8) 0 1px, rgba(255,255,255,0) 2px 12px),
        radial-gradient(40% 60% at 50% 50%, rgba(255,255,255,.3), rgba(255,255,255,0) 60%);
      filter: blur(2px) drop-shadow(0 0 8px rgba(255,240,180,.9));
      mix-blend-mode: screen; opacity:.55;
      animation: arcs 1.8s ease-in-out infinite alternate;
      pointer-events:none;
    }
    .btn-earn:hover{ filter: brightness(1.04) saturate(1.02); }
    .btn-earn:active{ transform: translateY(1px); box-shadow:
        inset 0 1px 0 rgba(255,255,255,.25),
        inset 0 -1px 0 rgba(170,110,10,.25),
        0 10px 22px rgba(255,200,80,.32),
        0 3px 0 rgba(150,100,10,.35); }

    @keyframes electric{
      from{ transform: translateX(-45%) translateY(-12%) rotate(10deg); }
      to  { transform: translateX(45%)  translateY(12%)  rotate(10deg); }
    }
    @keyframes arcs{
      0%  { transform: translateY(-2px) scale(1); opacity:.55; }
      50% { transform: translateY(2px)  scale(1.02); opacity:.75; }
      100%{ transform: translateY(-1px) scale(1.01); opacity:.60; }
    }

    .tasks-modal{
      position:fixed; inset:0; z-index:60; display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,.55); backdrop-filter: blur(4px) saturate(120%);
      padding: max(14px, env(safe-area-inset-top)) 14px max(14px, env(safe-area-inset-bottom)) 14px;
    }
    .tasks-frame-wrap{
      width:min(96vw, 720px);
      height:min(86vh, 860px);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.18);
      border-radius:16px; overflow:hidden; position:relative;
      box-shadow: 0 14px 40px rgba(0,0,0,.55);
    }
    .tasks-close{
      position:absolute; top:8px; right:8px; z-index:2;
      border:none; border-radius:10px; padding:6px 10px; font-weight:900; cursor:pointer;
      background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.08));
      color:#fff; box-shadow: 0 4px 12px rgba(0,0,0,.35);
    }
    .tasks-iframe{
      position:absolute; inset:0; width:100%; height:100%; border:0; background:#0b0f16;
    }
  </style>
</head>
<body>
  <div class="glow"></div>

  <div class="wrap" id="app-wrap">
    <div class="card">
      <div class="topbar">
        <div class="icon-btn" id="back-btn" title="Back" aria-label="Back">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
        </div>
        <div class="icon-btn" id="cfg-btn" title="Settings" aria-label="Settings">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M19.14 12.94c.04-.31.06-.63.06-.94s-.02-.63-.06-.94l2.03-1.58a.5.5 0 0 0 .12-.64l-1.92-3.32a.5.5 0 0 0-.61-.22l-2.39.96a7.03 7.03 0 0 0-1.63-.94l-.36-2.54A.5.5 0 0 0 13.9 1h-3.8a.5.5 0 0 0-.49.41l-.36 2.54c-.58.23-1.12.54-1.63.94l-2.39-.96a.5.5 0 0 0-.61.22L2.7 7.05a.5.5 0 0 0 .12.64L4.85 9.27c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58a.5.5 0 0 0-.12.64l1.92 3.32c.13.22.4.31.61.22l2.39-.96c.51.4 1.05.71 1.63.94l.36 2.54c.04.24.25.41.49.41h3.8c.24 0 .45-.17.49-.41l.36-2.54c.58-.23 1.12-.54 1.63-.94l2.39.96c.22.09.48 0 .61-.22l1.92-3.32a.5.5 0 0 0-.12-.64l-2.03-1.58zM12 15.5a3.5 3.5 0 1 1 0-7 3.5 3.5 0 0 1 0 7z"/></svg>
        </div>
      </div>

      <div class="scroll">
        <section class="profile">
          <!-- Ranked area (badge + progress) -->
          <div class="ranked">
            <div id="rank-name" class="rank-name">Iron</div>
            <div class="rank-badge-wrap" aria-live="polite">
              <img id="rank-badge" class="rank-badge" src="assets/iron.png" alt="Rank badge" draggable="false">
            </div>
            <div class="rank-progress">
              <div class="progress-bar" aria-label="Rank progress">
                <div id="rank-progress-fill" class="fill" style="width:0%"></div>
              </div>
              <div class="progress-meta">
                <span id="rank-progress-text">0 / 1500</span>
                <svg class="up" viewBox="0 0 24 24" aria-hidden="true">
                  <path fill="#39e58a" d="M12 4l6 8h-4v8h-4v-8H6z"/>
                </svg>
              </div>
              <div id="rank-next-need" class="next-need">Need 1500 WLC to reach Bronze</div>
            </div>
          </div>

          <div class="namebox">
            <div id="player-name" class="nickname">Player</div>
          </div>
        </section>

        <section class="balances">
          <div class="bal bal-wlc">
            <div class="bal-head">
              <div class="bal-id">
                <img src="assets/wellcoin-icon.png" alt="WLC">
                <span>WLC</span>
              </div>
            </div>
            <div class="bal-amt" id="wlc-amount">0.000000</div>
            <button class="bal-cta wlc" id="wlc-withdraw">Withdraw</button>
          </div>
          <div class="bal bal-usdt">
            <div class="bal-head">
              <div class="bal-id">
                <img src="assets/usdt.png" alt="USDT">
                <span>USDT</span>
              </div>
            </div>
            <div class="bal-amt" id="usdt-amount">0.00000</div>
            <button class="bal-cta usdt" id="usdt-withdraw">Withdraw</button>
          </div>
        </section>

        <section>
          <div class="section-title">Daily Achievements</div>
          <div id="ach" class="ach"></div>
        </section>

        <div class="divider" role="separator" aria-hidden="true"></div>

        <section>
          <div class="section-title">Daily tasks</div>
          <div class="tasks-cta">
            <button id="start-earn" class="btn-earn"><span>Start Earn</span></button>
          </div>
        </section>

        <div class="spacer"></div>
      </div>
    </div>
  </div>

  <div id="mask" class="mask" style="display:none">
    <div class="pop">
      <h3 id="pop-title">Congratulations!</h3>
      <div id="pop-desc" class="desc">You’ve received a reward.</div>
      <div id="pop-reward" class="reward">+ 0.000000 WLC</div>
      <button id="pop-ok" class="ok">Claim</button>
    </div>
  </div>
  <canvas id="confetti" class="confetti"></canvas>
  <div id="gate" class="gate">Please open this page from Telegram App.</div>

  <!-- Daily tasks modal (loads tasks.html when available) -->
  <div id="tasks-modal" class="tasks-modal" style="display:none">
    <div class="tasks-frame-wrap">
      <button id="tasks-close" class="tasks-close">Close</button>
      <iframe id="tasks-frame" class="tasks-iframe" title="Daily tasks"></iframe>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <!-- Keep music alive -->
  <script>
    (function audioBoot(){
      let a = document.getElementById('preloadAudio');
      if (!a) {
        a = document.createElement('audio');
        a.id = 'preloadAudio';
        a.loop = true; a.preload='auto'; a.style.display='none';
        a.src = 'assets/preload.mp3';
        document.body.appendChild(a);
      }
      function persist(){ try{
        sessionStorage.setItem('wlc_music_ct', String(a.currentTime||0));
        sessionStorage.setItem('wlc_music_track','assets/preload.mp3');
      }catch{}}
      function prime(){ try{ a.muted = true; a.volume=.76; a.play().catch(()=>{});}catch{}}
      function unmute(){ a.muted=false; a.volume=.76; a.play().catch(()=>{}); }
      prime();
      const ensure = ()=>{ unmute(); off(); };
      function off(){ ['pointerdown','touchstart','click','keydown'].forEach(ev=>document.removeEventListener(ev,ensure,{passive:true})); }
      ['pointerdown','touchstart','click','keydown'].forEach(ev=>document.addEventListener(ev,ensure,{passive:true, once:true}));
      window.addEventListener('pagehide', persist); window.addEventListener('beforeunload', persist);
      document.addEventListener('visibilitychange', ()=>{ if (document.hidden) persist(); else a.play().catch(()=>{}); });
    })();
  </script>

  <!-- Page Logic -->
  <script>
    // Light obfuscation / reduce console noise in production
    (function harden(){
      try{
        // Disable right-click, image drag, and common dev hotkeys
        document.addEventListener('contextmenu', e=>e.preventDefault());
        document.addEventListener('dragstart', e=>e.preventDefault(), {passive:false});
        document.addEventListener('keydown', e=>{
          const k = e.key?.toLowerCase();
          if (k==='f12' || (e.ctrlKey&&e.shiftKey&&(k==='i'||k==='j'||k==='c')) || (e.ctrlKey && k==='u')) { e.preventDefault(); e.stopPropagation(); }
        }, true);
        // Mute console in production surfaces
        ['log','info','debug'].forEach(m=>{ try{ console[m]=()=>{} }catch{} });
      }catch{}
    })();

    // Telegram + robust userId with fallback to storage
    const tg = window.Telegram?.WebApp;
    try { tg && tg.ready(); } catch(e){}
    let tgUser = tg?.initDataUnsafe?.user || null;
    let userId = tgUser?.id || null;

    function storedId(){
      try{
        return sessionStorage.getItem('wlc_user_id') || localStorage.getItem('wlc_user_id') || null;
      }catch{ return null; }
    }
    function ensureUserId(cb){
      if (!userId) userId = storedId();
      if (userId) { authOK = true; return cb(); }
      setTimeout(()=>{
        tgUser = tg?.initDataUnsafe?.user || tgUser;
        userId = tgUser?.id || storedId();
        if (userId) { authOK = true; cb(); }
        else {
          showGate(true);
          try{ window.location.replace('welcome.html'); }catch{}
        }
      }, 80);
    }

    // Gate display for unauthorized access
    let authOK = false;
    function showGate(show){
      const g = document.getElementById('gate');
      g.style.display = show ? 'flex' : 'none';
      const app = document.getElementById('app-wrap');
      app.style.filter = show ? 'blur(6px) brightness(.6)' : '';
      app.style.pointerEvents = show ? 'none' : '';
    }
    // Early hard gate if not in Telegram
    setTimeout(()=>{
      if (!authOK && !(tg && tg.initDataUnsafe && tg.initDataUnsafe.user)) showGate(true);
    }, 200);

    // IndexedDB helpers
    const IDB_NAME='wellcoin_game_cache', IDB_STORE='cache';
    function openIDB(){ return new Promise((res,rej)=>{ const r=indexedDB.open(IDB_NAME,1); r.onupgradeneeded=()=>{const db=r.result; if(!db.objectStoreNames.contains(IDB_STORE)) db.createObjectStore(IDB_STORE);}; r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error);});}
    function idbGet(key){ return openIDB().then(db=>new Promise((res,rej)=>{ const tx=db.transaction(IDB_STORE,'readonly'); const rq=tx.objectStore(IDB_STORE).get(key); rq.onsuccess=()=>res(rq.result); rq.onerror=()=>rej(rq.error);}));}
    function idbSet(key,val){ return openIDB().then(db=>new Promise((res,rej)=>{ const tx=db.transaction(IDB_STORE,'readwrite'); tx.objectStore(IDB_STORE).put(val,key); tx.oncomplete=res; tx.onerror=()=>rej(tx.error);}));}

    // UI refs
    const backBtn = document.getElementById('back-btn');
    const cfgBtn  = document.getElementById('cfg-btn');

    const nameEl = document.getElementById('player-name');
    const wlcEl  = document.getElementById('wlc-amount');
    const usdtEl = document.getElementById('usdt-amount');
    const achGrid= document.getElementById('ach');
    const mask   = document.getElementById('mask');
    const popOk  = document.getElementById('pop-ok');

    // Rank UI refs
    const rankNameEl = document.getElementById('rank-name');
    const rankBadgeEl= document.getElementById('rank-badge');
    const rankFillEl = document.getElementById('rank-progress-fill');
    const rankTextEl = document.getElementById('rank-progress-text');
    const rankNeedEl = document.getElementById('rank-next-need');

    // Tasks modal refs
    const tasksModal = document.getElementById('tasks-modal');
    const tasksFrame = document.getElementById('tasks-frame');
    const tasksClose = document.getElementById('tasks-close');

    backBtn.addEventListener('click', (e)=>{ e.preventDefault(); go('index.html'); });
    cfgBtn.addEventListener('click', (e)=>{ e.preventDefault(); go('config.html'); });
    function go(url){
      try{
        const a = document.getElementById('preloadAudio');
        if (a) {
          sessionStorage.setItem('wlc_music_ct', String(a.currentTime||0));
          sessionStorage.setItem('wlc_music_track','assets/preload.mp3');
        }
      }catch{}
      window.location.href = url;
    }

    // Formatters
    const fmtInt = v => Number(v||0).toLocaleString("en-US",{maximumFractionDigits:0});
    const fmtWLC = v => Number(v||0).toLocaleString("en-US",{minimumFractionDigits:6, maximumFractionDigits:6});
    // USDT with 5 decimals as requested
    const fmtUSD = v => Number(v||0).toLocaleString("en-US",{minimumFractionDigits:5, maximumFractionDigits:5});
    const msToHMS = (ms)=>{ if(ms<0) ms=0; const s=Math.floor(ms/1000)%60, m=Math.floor(ms/60000)%60, h=Math.floor(ms/3600000); return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; };

    // Build achievements tiles (visual only) - timer below card, check above image
    const SPECIAL = new Set([7,15,24,30]);
    function buildGrid(){
      achGrid.innerHTML = '';
      for(let i=1;i<=30;i++){
        const d = document.createElement('div');
        d.className = 'day' + (SPECIAL.has(i)?' special':'');
        d.dataset.day = i;
        d.innerHTML = `
          <div class="cap">
            <span class="pin l"></span>
            <span class="pin r"></span>
            Day ${i}
          </div>
          <div class="body">
            <img class="gift-img" src="assets/gift.png" alt="gift" draggable="false">
          </div>
          <div class="timer" style="display:none"></div>
          <div class="check">
            <div class="mark">
              <svg viewBox="0 0 64 64" aria-hidden="true">
                <defs>
                  <radialGradient id="g" cx="50%" cy="50%" r="50%">
                    <stop offset="0%" stop-color="#9cffc8" stop-opacity="1"/>
                    <stop offset="70%" stop-color="#45e27f" stop-opacity="0.9"/>
                    <stop offset="100%" stop-color="#00c060" stop-opacity="0.0"/>
                  </radialGradient>
                </defs>
                <circle cx="32" cy="32" r="22" fill="url(#g)"></circle>
                <path d="M22 33.5l6 6 14-14" fill="none" stroke="#dfffef" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
          </div>
        `;
        achGrid.appendChild(d);
      }
    }
    buildGrid();

    // Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyB9uNwUURvf5RsD7CnsG2LtE6fz5yboBkw",
      authDomain: "wellcoinbotgame.firebaseapp.com",
      databaseURL: "https://wellcoinbotgame-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "wellcoinbotgame",
      storageBucket: "wellcoinbotgame.appspot.com",
      messagingSenderId: "108640533638",
      appId: "1:108640533638:web:ed07516d96ac38f47f6507"
    };
    const app = (firebase.apps && firebase.apps.length) ? firebase.app() : firebase.initializeApp(firebaseConfig);
    const db = firebase.database(app);

    // Server time offset
    let serverOffset = 0;
    db.ref(".info/serverTimeOffset").on("value", s=>{ serverOffset = s.val()||0; });
    const now = ()=> Date.now() + serverOffset;

    // State
    let daily = null, timerId = null;

    function ensureStateInit(u, tNow){
      if (!u) u = {};
      if (!u.meDailyState){
        u.meDailyState = {
          currentDay: 1,
          lastClaimAt: 0,
          nextAvailableAt: tNow,
          expiresAt: tNow + 8*3600*1000,
          claimedDays: {},
          version: 1
        };
      } else {
        const st = u.meDailyState;
        if (tNow > (st.expiresAt||0) && tNow >= (st.nextAvailableAt||0)){
          u.meDailyState = {
            currentDay: 1, lastClaimAt: 0,
            nextAvailableAt: tNow, expiresAt: tNow + 8*3600*1000,
            claimedDays: {}, version: (st.version||1)
          };
        }
      }
      if (typeof u.usdtBalance !== 'number') u.usdtBalance = 0;
      if (typeof u.balance !== 'number') u.balance = 0;
      return u;
    }

    function rewardFor(day){
      if (day===7)  return { type:'WLC', amount:0.1,  label:'+0.100000 WLC' };
      if (day===15) return { type:'USDT',amount:0.2,  label:'+0.20000 USDT' };
      if (day===24) return { type:'WLC', amount:1.0,  label:'+1.000000 WLC' };
      if (day===30) return { type:'WLC_MEDAL', amount:2.0, label:'+2.000000 WLC + Medal' };
      const pool = [
        {type:'WLC',  amount:0.000005, label:'+0.000005 WLC'},
        {type:'WLC',  amount:0.00004,  label:'+0.000040 WLC'},
        {type:'USDT', amount:0.002,    label:'+0.00200 USDT'},
        {type:'USDT', amount:0.01,     label:'+0.01000 USDT'},
      ];
      return pool[Math.floor(Math.random()*pool.length)];
    }

    function render(){
      if (!daily) return;
      const t = now(), st = daily;
      document.querySelectorAll('.day').forEach(tile=>{
        const day = Number(tile.dataset.day);
        tile.classList.remove('locked','claimable','claimed');
        const timerEl = tile.querySelector('.timer');
        timerEl.style.display='none'; timerEl.textContent='';

        const claimed = !!(st.claimedDays && st.claimedDays[day]);
        if (claimed){ tile.classList.add('claimed'); return; }
        if (day < st.currentDay){ tile.classList.add('claimed'); return; }
        if (day > st.currentDay){ tile.classList.add('locked'); return; }

        if (t >= st.nextAvailableAt && t <= st.expiresAt){
          tile.classList.add('claimable');
        } else if (t < st.nextAvailableAt){
          tile.classList.add('locked');
          timerEl.style.display='';
          timerEl.textContent = msToHMS(st.nextAvailableAt - t); // only time
        } else {
          tile.classList.add('locked');
        }
      });
    }

    // Confetti
    function confetti(){
      const c = document.getElementById('confetti'), x = c.getContext('2d');
      let W = c.width = innerWidth, H = c.height = innerHeight;
      const P = Array.from({length: 110}, ()=>({
        x: Math.random()*W, y: -10-Math.random()*H*0.2,
        r: 3+Math.random()*4, c: `hsl(${Math.random()*360}, 90%, 60%)`,
        vx: -1+Math.random()*2, vy: 1+Math.random()*2.5, g:.05+Math.random()*.1, a:1
      }));
      let run = true, t0 = performance.now();
      function frame(t){
        if (!run) return;
        x.clearRect(0,0,W,H);
        for (const p of P){
          p.vy += p.g; p.x += p.vx; p.y += p.vy; p.a -= 0.004;
          x.globalAlpha = Math.max(0,p.a); x.fillStyle = p.c; x.fillRect(p.x, p.y, p.r, p.r);
        }
        if (t - t0 < 2600) requestAnimationFrame(frame); else { run=false; x.clearRect(0,0,W,H); }
      }
      requestAnimationFrame(frame);
      addEventListener('resize', ()=>{ W=c.width=innerWidth; H=c.height=innerHeight; }, { once:true });
    }

    function showPop(title, desc, reward){
      document.getElementById('pop-title').textContent = title || 'Congratulations!';
      document.getElementById('pop-desc').innerHTML  = desc || 'You’ve received a reward.';
      document.getElementById('pop-reward').textContent = reward || '';
      mask.style.display='flex'; confetti();
    }
    popOk.addEventListener('click', ()=>{ mask.style.display='none'; });

    function attachTileHandlers(userRef){
      achGrid.addEventListener('click', (e)=>{
        const tile = e.target.closest('.day'); if (!tile) return;
        const day = Number(tile.dataset.day); if (day !== daily.currentDay) return;
        const t = now(); if (t < daily.nextAvailableAt || t > daily.expiresAt) return;
        claim(userRef, day);
      });
    }

    async function sync(userRef){
      const tNow = now();
      await userRef.transaction(u=>{
        u = ensureStateInit(u, tNow);
        const st = u.meDailyState;
        if (tNow > st.expiresAt && tNow >= st.nextAvailableAt){
          u.meDailyState = {
            currentDay: 1, lastClaimAt: 0,
            nextAvailableAt: tNow, expiresAt: tNow + 8*3600*1000,
            claimedDays: {}, version: st.version||1
          };
        }
        return u;
      });
      const snap = await userRef.once('value');
      daily = snap.val().meDailyState;
      render();

      if (!timerId){
        timerId = setInterval(()=>{
          const t = now();
          render();
          if (t > daily.expiresAt) { sync(userRef).catch(()=>{}); }
        }, 1000);
      }
    }

    async function claim(userRef, day){
      const tNow = now(); let reward = null;
      await userRef.transaction(u=>{
        u = ensureStateInit(u, tNow);
        const st = u.meDailyState;
        if (day !== st.currentDay) return u;
        if (tNow < st.nextAvailableAt || tNow > st.expiresAt) return u;

        const rw = rewardFor(day);
        if (rw.type.startsWith('WLC')) u.balance = (u.balance||0) + rw.amount;
        if (rw.type==='USDT')         u.usdtBalance = (u.usdtBalance||0) + rw.amount;

        st.claimedDays = st.claimedDays || {};
        st.claimedDays[String(day)] = tNow;
        st.lastClaimAt = tNow;

        if (day >= 30){
          st.currentDay = 1;
          st.nextAvailableAt = tNow + 24*3600*1000;
          st.expiresAt = st.nextAvailableAt + 8*3600*1000;
          st.claimedDays = {};
        } else {
          st.currentDay = day + 1;
          st.nextAvailableAt = tNow + 24*3600*1000;
          st.expiresAt = st.nextAvailableAt + 8*3600*1000;
        }
        u.meDailyState = st; reward = rw; return u;
      });

      const s = await userRef.once('value');
      daily = s.val().meDailyState; render();

      if (reward){
        if (reward.type.startsWith('WLC')){
          const newW = s.val().balance || 0;
          wlcEl.textContent = fmtWLC(newW);
          idbSet(`wlc:${userId}:balance`, newW).catch(()=>{});
          updateRankUI(newW);
        } else {
          const newU = s.val().usdtBalance || 0;
          usdtEl.textContent = fmtUSD(newU);
        }
        showPop('Congratulations!', 'Your daily reward has been added to your balance.', reward.label);
      }
    }

    // Rank definitions and UI update
    const RANKS = [
      { name:'Iron',         key:'iron',        min:     0, img:'iron.png' },
      { name:'Bronze',       key:'bronze',      min:  1500, img:'bronze.png' },
      { name:'Silver',       key:'silver',      min:  3000, img:'silver.png' },
      { name:'Gold',         key:'gold',        min:  5000, img:'gold.png' },
      { name:'Platinum',     key:'plat',        min:  8000, img:'plat.png' },
      { name:'Emerald',      key:'emrald',      min: 10500, img:'emrald.png' },
      { name:'Diamond',      key:'diamon',      min: 15000, img:'diamon.png' },
      { name:'Master',       key:'master',      min: 20000, img:'master.png' },
      { name:'Grand Master', key:'grandmaster', min: 30000, img:'grandmaster.png' },
      { name:'Challenger',   key:'challenger',  min: 50000, img:'challenger.png' }
    ];
    function computeRank(balance){
      const b = Math.max(0, Number(balance||0));
      let idx = 0;
      for (let i=0;i<RANKS.length;i++){ if (b >= RANKS[i].min) idx = i; }
      const cur = RANKS[idx];
      const next = RANKS[idx+1] || null;
      const min = cur.min;
      const nextMin = next ? next.min : null;
      let pct = 1;
      if (nextMin !== null){
        pct = Math.max(0, Math.min(1, (b - min) / (nextMin - min)));
      }
      return { b, cur, next, min, nextMin, pct };
    }
    function updateRankUI(balance){
      const { b, cur, next, min, nextMin, pct } = computeRank(balance);
      rankNameEl.textContent = cur.name;
      const imgPath = `assets/${cur.img}`;
      if (rankBadgeEl.getAttribute('src') !== imgPath){
        rankBadgeEl.setAttribute('src', imgPath);
        rankBadgeEl.setAttribute('alt', `${cur.name} badge`);
      }
      rankFillEl.style.width = `${Math.round(pct*100)}%`;

      if (nextMin === null){
        rankTextEl.textContent = `${fmtInt(b)} / ${fmtInt(cur.min)}+`;
        rankNeedEl.textContent = `Max Rank • ${cur.name}`;
      } else {
        rankTextEl.textContent = `${fmtInt(b)} / ${fmtInt(nextMin)}`;
        const need = Math.max(0, nextMin - b);
        rankNeedEl.textContent = need > 0
          ? `Need ${fmtInt(need)} WLC to reach ${next.name}`
          : `Ready to advance to ${next.name}!`;
      }
    }

    // Name hydration (robust and reactive)
    function bestNameFromFirebase(u){
      if (!u || typeof u !== 'object') return null;
      const p = u.profile || {};
      const direct = u.displayName || u.name || u.nickname || u.username;
      const prof = p.displayName || p.name || p.nickname || p.username;
      const first = u.firstName || p.firstName || (u.first_name) || null;
      const last  = u.lastName  || p.lastName  || (u.last_name)  || null;

      if (direct) return String(direct);
      if (prof) return String(prof);
      const combo = [first,last].filter(Boolean).join(' ').trim();
      if (combo) return combo;
      return null;
    }
    async function hydrateName(){
      try{
        const snap = await db.ref('users/'+userId).once('value');
        const u = snap.val();
        const n = bestNameFromFirebase(u);
        if (n){ nameEl.textContent = n; try{ await idbSet(`wlc:${userId}:tgName`, n); }catch{} }
      }catch{}

      try{
        const cachedName = await idbGet(`wlc:${userId}:tgName`);
        if (cachedName && !/^\s*$/.test(String(cachedName))) {
          nameEl.textContent = cachedName;
        }
      }catch{}

      const tgFull = [tgUser?.first_name||'', tgUser?.last_name||''].filter(Boolean).join(' ').trim();
      const tgHandle = tgUser?.username ? '@'+tgUser.username : '';
      const fallback = tgFull || tgHandle || 'Player';
      if (nameEl.textContent === 'Player' || nameEl.textContent.trim() === ''){
        nameEl.textContent = fallback;
      }

      try{
        db.ref('users/'+userId).on('value', s=>{
          const nu = s.val();
          const n2 = bestNameFromFirebase(nu);
          if (n2 && nameEl.textContent !== n2){
            nameEl.textContent = n2;
            idbSet(`wlc:${userId}:tgName`, n2).catch(()=>{});
          }
        });
      }catch{}
    }

    // Daily tasks open/close handlers (loads tasks.html when available)
    function openTasks(){
      try{
        tasksFrame.src = 'tasks.html';
        tasksModal.style.display = 'flex';
      }catch(e){
        // fallback: navigate
        window.location.href = 'tasks.html';
      }
    }
    function closeTasks(){
      tasksModal.style.display = 'none';
      try{ tasksFrame.src = 'about:blank'; }catch{}
    }

    function init(){
      try{
        sessionStorage.setItem('wlc_user_id', String(userId));
        localStorage.setItem('wlc_user_id', String(userId));
      }catch{}

      hydrateName();

      (async ()=>{
        const cached = await idbGet(`wlc:${userId}:balance`).catch(()=>null);
        if (typeof cached === 'number'){
          wlcEl.textContent = fmtWLC(cached);
          updateRankUI(cached);
        } else {
          updateRankUI(0);
        }
      })();

      const userRef = db.ref('users/'+userId);
      db.ref('users/'+userId+'/balance').on('value', s=>{
        const v = typeof s.val()==='number' ? s.val() : 0;
        wlcEl.textContent = fmtWLC(v);
        idbSet(`wlc:${userId}:balance`, v).catch(()=>{});
        updateRankUI(v);
      });
      db.ref('users/'+userId+'/usdtBalance').on('value', s=>{
        const v = typeof s.val()==='number' ? s.val() : 0;
        usdtEl.textContent = fmtUSD(v);
      });

      document.getElementById('wlc-withdraw').addEventListener('click', ()=>alert('Withdraw WLC: Coming soon'));
      document.getElementById('usdt-withdraw').addEventListener('click', ()=>alert('Withdraw USDT: Coming soon'));

      // Daily tasks button + modal close
      const earnBtn = document.getElementById('start-earn');
      if (earnBtn) earnBtn.addEventListener('click', openTasks);
      if (tasksClose) tasksClose.addEventListener('click', closeTasks);
      tasksModal?.addEventListener('click', (e)=>{ if (e.target === tasksModal) closeTasks(); });

      sync(userRef).catch(console.warn);
      attachTileHandlers(userRef);
    }

    ensureUserId(init);
  </script>
</body>
</html>
