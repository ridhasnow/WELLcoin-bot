<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Me</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="color-scheme" content="dark">
  <style>
    :root{
      --bg:#05070b;
      --glass:rgba(20,24,32,0.62);
      --glass-border:rgba(150,175,250,0.20);
      --text:#eef3ff;
      --muted:#b9c3d9;
      --gold:#ffd36a; --gold-2:#ffe9a8;
      --green:#39e58a; --green-2:#9dffd0;
      --blue:#70a0ff; --danger:#ff6b6b;
      --shadow-1:0 12px 40px rgba(0,0,0,.55);
      --shadow-2:0 6px 18px rgba(0,0,0,.40);
      --r-lg:22px; --r-md:14px; --r-sm:10px;
      --t-fast:.12s ease-out; --t-med:.18s ease-out;
    }

    html,body{height:100%}
    body{ margin:0; background:#000; color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
      overflow:hidden;
    }
    
    img, svg {
      -webkit-user-select: none; user-select: none;
      -webkit-user-drag: none; -webkit-touch-callout: none;
    }

    .glow{
      position:fixed; inset:0; z-index:0; pointer-events:none;
      background:
        radial-gradient(60vw 60vw at 15% 20%, rgba(255, 215, 90, 0.09), transparent 70%),
        radial-gradient(50vw 50vw at 80% 25%, rgba(255, 240, 140, 0.07), transparent 70%),
        radial-gradient(70vw 70vw at 50% 85%, rgba(220, 180, 100, 0.08), transparent 70%);
      transform: translateX(-40px);
      filter: blur(15px) saturate(130%);
    }
    .wrap{
      position:relative; z-index:1; width:100%; height:100%;
      display:flex; align-items:center; justify-content:center;
      padding: max(14px, env(safe-area-inset-top)) 14px max(14px, env(safe-area-inset-bottom)) 14px;
    }
    .card{
      width:min(96vw, 620px);
      height:min(96vh, 900px);
      background: linear-gradient(180deg, rgba(30,36,50,0.50), rgba(18,22,30,0.58));
      border-radius: var(--r-lg);
      border: 1px solid var(--glass-border);
      box-shadow: var(--shadow-1);
      backdrop-filter: blur(10px) saturate(120%);
      position:relative; overflow:hidden; display:flex; flex-direction:column;
      margin-inline:auto;
    }
    .card::before{
      content:""; position:absolute; inset:0; border-radius: var(--r-lg);
      padding:1px; background:
        linear-gradient(135deg, rgba(255,220,120,.28), rgba(120,190,255,.22), rgba(80,255,170,.25));
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude; pointer-events:none; opacity:.85;
    }

    .topbar{
      position:absolute; inset:0 0 auto 0; height:56px;
      display:flex; align-items:center; justify-content:space-between;
      padding: 10px 12px; z-index:2;
    }
    .icon-btn{
      width:38px; height:38px; border-radius:12px;
      display:flex; align-items:center; justify-content:center;
      background: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.04));
      border: 1px solid rgba(255,255,255,0.12);
      color:#fff; cursor:pointer; user-select:none;
      transition: transform var(--t-fast), background var(--t-med), border-color var(--t-med);
      box-shadow: var(--shadow-2); backdrop-filter: blur(6px);
    }
    .icon-btn:hover{ background: rgba(255,255,255,0.12); border-color: rgba(255,255,255,0.2); }
    .icon-btn:active{ transform: scale(.97); }
    .icon-btn svg{ width:18px; height:18px; fill:#eaf2ff; opacity:.95 }

    .scroll{ flex:1; overflow:auto; -webkit-overflow-scrolling:touch; padding: 62px 16px 18px 16px; }

    .profile{ display:flex; flex-direction:column; align-items:center; gap:14px; text-align:center; }
    
    .rank-display {
      width: 140px; height: 140px; display: grid; place-items: center;
    }
    #rank-cadre {
      max-width: 100%; max-height: 100%; object-fit: contain;
      filter: drop-shadow(0 0 8px rgba(120, 180, 255, 0.35)) drop-shadow(0 0 20px rgba(120, 180, 255, 0.2));
    }
    .rank-progress {
      display: flex; align-items: center; gap: 10px; width: 80%; max-width: 300px; margin-top: 4px;
    }
    .progress-bar {
      flex-grow: 1; height: 10px; background-color: rgba(0,0,0,0.3);
      border-radius: 5px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1);
    }
    #progress-fill {
      width: 0%; height: 100%; background: linear-gradient(90deg, var(--green), var(--blue));
      border-radius: 5px; transition: width 0.5s ease-out;
    }
    #progress-text {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 0.8rem; font-weight: 700; color: var(--muted); white-space: nowrap;
    }
    .progress-arrow {
      font-size: 1.5rem; color: var(--green); text-shadow: 0 0 8px var(--green), 0 0 12px rgba(57, 229, 138, 0.5);
      animation: pulse-arrow 1.5s infinite alternate;
    }
    @keyframes pulse-arrow { from { transform: translateY(2px); opacity: 0.8; } to { transform: translateY(-2px); opacity: 1; } }

    .namebox{
      display:inline-flex; flex-direction:column; gap:4px; align-items:center;
      padding:10px 16px; border-radius: 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.12); box-shadow: inset 0 1px 0 rgba(255,255,255,.10);
      min-width: 62%;
    }
    .nickname{
      font-weight:900; letter-spacing:.2px; font-size:1.15rem;
      background: linear-gradient(90deg, #fff, #dfe9ff);
      -webkit-background-clip: text; background-clip:text; color: transparent;
      text-shadow: 0 1px 2px rgba(0,0,0,.35);
    }

    .balances{ margin-top:14px; display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 420px){ .balances{ grid-template-columns: 1fr; } }
    .bal{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border:1px solid rgba(255,255,255,.14);
      border-radius: var(--r-md); padding: 12px; box-shadow: var(--shadow-2);
      display:flex; flex-direction:column; gap:10px;
    }
    .bal-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .bal-id{ display:flex; align-items:center; gap:8px; font-weight:800; letter-spacing:.3px; color:#eef3ff; }
    .bal-id img{ width:18px; height:18px; object-fit:contain; }
    .bal-amt{
      display:flex; align-items:baseline; gap:6px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-weight:900; letter-spacing:.3px; text-shadow: 0 0 10px rgba(255,255,255,.06);
    }
    .bal-wlc .bal-amt{ color: var(--gold); }
    .bal-usdt .bal-amt{ color: var(--green); }
    .bal-cta{ align-self:flex-start; border:none; border-radius: 10px; padding:8px 13px; font-weight:900; cursor:pointer;
      transition: transform var(--t-fast), box-shadow var(--t-med), filter var(--t-fast);
    }
    .bal-cta:active{ transform: translateY(1px) scale(0.99); }
    .bal-cta.wlc{ background: linear-gradient(90deg, var(--gold), var(--gold-2)); color:#222; box-shadow: 0 6px 16px rgba(255, 210, 90, .30); }
    .bal-cta.usdt{ background: linear-gradient(90deg, var(--green), var(--green-2)); color:#0d2418; box-shadow: 0 6px 16px rgba(60, 220, 130, .28); }

    .section-title{
      margin: 18px 2px 10px 4px; font-weight:900; letter-spacing:.3px; font-size:1.02rem; color:#e9f1ff;
      display:flex; align-items:center; gap:8px;
    }
    .section-title::before{
      content:""; width:8px; height:8px; border-radius:999px;
      background: radial-gradient(circle, #ffd36a, #8affc2);
      box-shadow: 0 0 10px rgba(255,211,106,.45);
    }

    .ach{ display:grid; grid-template-columns: repeat(5, minmax(0, 1fr)); gap:12px; }

    .day{
      position:relative; border-radius:14px; overflow:hidden; user-select:none;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border:1px solid rgba(255,255,255,.14); box-shadow: 0 6px 18px rgba(0,0,0,.40);
      display:flex; flex-direction:column; aspect-ratio: 1 / 1.05; margin-bottom: 30px;
    }
    .day.special{ transform: scale(1.02); }

    .cap{
      position:relative; height: clamp(20px, 5vw, 26px);
      display:flex; align-items:center; justify-content:center;
      background: linear-gradient(180deg, #5aa4ff, #3385ff);
      color:#eaf3ff; font-weight:900; letter-spacing:.2px; text-shadow: 0 1px 2px rgba(0,0,0,.35);
      border-bottom: 1px solid rgba(0,0,0,.25); font-size: clamp(9px, 2.3vw, 12px);
      border-top-left-radius: 14px; border-top-right-radius: 14px; padding: 0 2px;
    }
    .day.special .cap{
      background: linear-gradient(180deg, #ffcb5a, #ffad33);
      color:#2a1a00; text-shadow: 0 1px 1px rgba(255,255,255,.35);
    }
    .cap .pin{ position:absolute; top:-5px; width:8px; height:8px; border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #fff, #bcd, #566); box-shadow: 0 1px 2px rgba(0,0,0,.5);
    }
    .cap .pin.l{ left:8px; } .cap .pin.r{ right:8px; }

    .body{
      position:relative; flex:1; display:flex; align-items:center; justify-content:center;
      padding: 4px; background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      overflow: hidden;
    }
    .gift-img{
      width: 100%; height: 100%; object-fit: cover; object-position: center;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,.35)) saturate(110%);
    }

    .timer{
      position:absolute; left:0; right:0; bottom:-22px;
      font-size:12px; font-weight:900; color:#d3ddff; opacity:.98; text-align:center;
      text-shadow: 0 1px 2px rgba(0,0,0,.5); pointer-events:none;
    }

    .day.locked{ filter: brightness(.92) saturate(.9); }
    .day.claimable{
      border-color: rgba(255,210,90,.55);
      box-shadow: 0 10px 24px rgba(255,210,90,.22), inset 0 0 0 1px rgba(255,255,255,.05);
      animation: pulse 1.4s ease-in-out infinite alternate; cursor: pointer;
    }
    @keyframes pulse{ from{ filter:none } to{ filter: drop-shadow(0 0 8px rgba(255,220,100,.36)); } }

    .check{
      position:absolute; inset:0; display:grid; place-items:center; pointer-events:none;
      opacity:0; transform: scale(.9); transition: opacity .2s ease, transform .2s ease;
    }
    .day.claimed .check{ opacity:1; transform: scale(1); }
    .check svg{ width:56px; height:56px; }

    .mask{
      position:fixed; inset:0; z-index:10; background:rgba(0,0,0,0.6); backdrop-filter:blur(8px);
      display:flex; align-items:center; justify-content:center; opacity:0; pointer-events:none; transition: opacity .2s ease;
    }
    .mask.show{ opacity:1; pointer-events:auto; }
    .pop{
      background: linear-gradient(160deg, var(--glass), rgba(12,15,20,0.75));
      border: 1px solid var(--glass-border); border-radius:var(--r-lg); padding:24px;
      width: min(90vw, 360px); text-align:center; box-shadow: var(--shadow-1);
      transform: scale(.95); transition: transform .2s ease;
    }
    .mask.show .pop{ transform: scale(1); }
    #pop-title{ margin:0 0 8px; font-size:1.4rem; font-weight:900; color:#fff; }
    #pop-desc{ margin:0 0 16px; color:var(--muted); font-size:.95rem; }
    #pop-reward{
      margin:0 auto 20px; font-weight:900; font-size:1.2rem;
      padding:10px 18px; border-radius:var(--r-md);
      background:rgba(0,0,0,0.25); border:1px solid rgba(255,255,255,0.1); display:inline-block;
    }
    #pop-reward.wlc { color:var(--gold); }
    #pop-reward.usdt { color:var(--green); }
    #pop-ok{
      width:100%; padding:12px; border:none; border-radius:var(--r-md);
      font-size:1rem; font-weight:900; cursor:pointer;
      background: linear-gradient(90deg, var(--gold), var(--gold-2)); color:#222;
      box-shadow: 0 6px 16px rgba(255, 210, 90, .30); transition: transform .1s ease;
    }
    #pop-ok:active{ transform:scale(.98); }
    .confetti{ position:fixed; inset:0; z-index:11; pointer-events:none; }
    .spacer{ height:14px; }
    * { -webkit-tap-highlight-color: rgba(0,0,0,0); }
  </style>
</head>
<body>
  <div class="glow"></div>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <div class="icon-btn" id="back-btn"><svg viewBox="0 0 24 24"><path d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg></div>
        <div class="icon-btn" id="cfg-btn"><svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.31.06-.63.06-.94s-.02-.63-.06-.94l2.03-1.58a.5.5 0 0 0 .12-.64l-1.92-3.32a.5.5 0 0 0-.61-.22l-2.39.96a7.03 7.03 0 0 0-1.63-.94l-.36-2.54A.5.5 0 0 0 13.9 1h-3.8a.5.5 0 0 0-.49.41l-.36 2.54c-.58.23-1.12.54-1.63.94l-2.39-.96a.5.5 0 0 0-.61.22L2.7 7.05a.5.5 0 0 0 .12.64L4.85 9.27c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58a.5.5 0 0 0-.12.64l1.92 3.32c.13.22.4.31.61.22l2.39-.96c.51.4 1.05.71 1.63.94l.36 2.54c.04.24.25.41.49.41h3.8c.24 0 .45-.17.49-.41l.36-2.54c.58-.23 1.12-.54-1.63-.94l2.39.96c.22.09.48 0 .61-.22l1.92-3.32a.5.5 0 0 0-.12-.64l-2.03-1.58zM12 15.5a3.5 3.5 0 1 1 0-7 3.5 3.5 0 0 1 0 7z"/></svg></div>
      </div>
      <div class="scroll">
        <section class="profile">
          <div class="rank-display"><img id="rank-cadre" src="assets/iron.png" alt=""></div>
          <div class="rank-progress">
            <div class="progress-bar"><div id="progress-fill"></div></div>
            <span id="progress-text">0 / 1500</span><span class="progress-arrow">↑</span>
          </div>
          <div class="namebox"><div id="player-name" class="nickname">Player</div></div>
        </section>
        <section class="balances">
          <div class="bal bal-wlc">
            <div class="bal-head"><div class="bal-id"><img src="assets/wellcoin-icon.png" alt="WLC"><span>WLC</span></div></div>
            <div class="bal-amt" id="wlc-amount">0.000000</div><button class="bal-cta wlc" id="wlc-withdraw">Withdraw</button>
          </div>
          <div class="bal bal-usdt">
            <div class="bal-head"><div class="bal-id"><img src="assets/usdt.png" alt="USDT"><span>USDT</span></div></div>
            <div class="bal-amt" id="usdt-amount">0.000</div><button class="bal-cta usdt" id="usdt-withdraw">Withdraw</button>
          </div>
        </section>
        <section>
          <div class="section-title">Daily Achievements</div><div id="ach" class="ach"></div>
        </section>
        <div class="spacer"></div>
      </div>
    </div>
  </div>
  <div id="mask" class="mask">
    <div class="pop">
      <h3 id="pop-title">Congratulations!</h3><div id="pop-desc" class="desc">You’ve received a reward.</div>
      <div id="pop-reward" class="reward"></div><button id="pop-ok" class="ok">Claim</button>
    </div>
  </div>
  <canvas id="confetti" class="confetti"></canvas>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
    // --- CORE SETUP ---
    const tg = window.Telegram?.WebApp;
    try { tg?.ready(); } catch (e) { console.error(e); }
    let tgUser = tg?.initDataUnsafe?.user || null;
    let userId = tgUser?.id || null;

    function storedId() {
      try { return sessionStorage.getItem('wlc_user_id') || localStorage.getItem('wlc_user_id'); } 
      catch { return null; }
    }

    function ensureUserId(callback) {
      if (!userId) userId = storedId();
      if (userId) return callback();
      setTimeout(() => {
        tgUser = tg?.initDataUnsafe?.user || tgUser;
        userId = tgUser?.id || storedId();
        if (userId) callback();
        else window.location.replace('welcome.html');
      }, 60);
    }
    
    // --- UI & FORMATTERS ---
    const nameEl = document.getElementById('player-name');
    const wlcEl = document.getElementById('wlc-amount');
    const usdtEl = document.getElementById('usdt-amount');
    const achGrid = document.getElementById('ach');
    const mask = document.getElementById('mask');
    const popOk = document.getElementById('pop-ok');
    const rankCadre = document.getElementById('rank-cadre');
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');
    const rankProgress = document.querySelector('.rank-progress');

    const fmtWLC = v => Number(v || 0).toLocaleString("en-US", { minimumFractionDigits: 6, maximumFractionDigits: 6 });
    const fmtUSD = v => Number(v || 0).toLocaleString("en-US", { minimumFractionDigits: 3, maximumFractionDigits: 3 });
    const msToHMS = ms => {
      if (ms < 0) ms = 0;
      const s = Math.floor(ms / 1000) % 60, m = Math.floor(ms / 60000) % 60, h = Math.floor(ms / 3600000);
      return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    };

    // --- FIREBASE & STATE ---
    const firebaseConfig = { apiKey: "AIzaSyB9uNwUURvf5RsD7CnsG2LtE6fz5yboBkw", authDomain: "wellcoinbotgame.firebaseapp.com", databaseURL: "https://wellcoinbotgame-default-rtdb.europe-west1.firebasedatabase.app", projectId: "wellcoinbotgame", storageBucket: "wellcoinbotgame.appspot.com", messagingSenderId: "108640533638", appId: "1:108640533638:web:ed07516d96ac38f47f6507" };
    const app = firebase.apps.length ? firebase.app() : firebase.initializeApp(firebaseConfig);
    const db = firebase.database(app);
    let serverOffset = 0;
    db.ref(".info/serverTimeOffset").on("value", s => { serverOffset = s.val() || 0; });
    const now = () => Date.now() + serverOffset;
    let dailyState = null;
    let dailyTimerInterval = null;

    // --- DAILY REWARD LOGIC ---
    function buildGrid() {
      achGrid.innerHTML = '';
      const SPECIAL = new Set([7, 15, 24, 30]);
      for (let i = 1; i <= 30; i++) {
        const d = document.createElement('div');
        d.className = 'day' + (SPECIAL.has(i) ? ' special' : '');
        d.dataset.day = i;
        d.innerHTML = `<div class="cap"><span class="pin l"></span><span class="pin r"></span>Day ${i}</div><div class="body"><img class="gift-img" src="assets/gift.png" alt="gift"><div class="timer"></div></div><div class="check"><svg viewBox="0 0 64 64"><defs><radialGradient id="g" cx="50%" cy="50%" r="50%"><stop offset="0%" stop-color="#9cffc8"/><stop offset="70%" stop-color="#45e27f" stop-opacity="0.9"/><stop offset="100%" stop-color="#00c060" stop-opacity="0.0"/></radialGradient></defs><circle cx="32" cy="32" r="22" fill="url(#g)"></circle><path d="M22 33.5l6 6 14-14" fill="none" stroke="#dfffef" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"/></svg></div>`;
        achGrid.appendChild(d);
      }
    }

    function renderDaily() {
        if (!dailyState) return;
        const currentTime = now();
        const state = dailyState;

        document.querySelectorAll('.day').forEach(tile => {
            const day = Number(tile.dataset.day);
            tile.classList.remove('locked', 'claimable', 'claimed');
            const timerEl = tile.querySelector('.timer');
            timerEl.style.display = 'none';

            const isClaimed = state.claimedDays && state.claimedDays[day];
            
            if (isClaimed) {
                tile.classList.add('claimed');
                return;
            }

            if (day < state.currentDay) {
                tile.classList.add('locked'); // Missed day
                return;
            }

            if (day > state.currentDay) {
                tile.classList.add('locked'); // Future day
                return;
            }

            // This is the current, active day (day === state.currentDay)
            if (currentTime < state.nextAvailableAt) {
                // Cooldown is active, show timer
                tile.classList.add('locked');
                timerEl.style.display = 'block';
                timerEl.textContent = msToHMS(state.nextAvailableAt - currentTime);
            } else {
                // Cooldown is over, it's claimable
                tile.classList.add('claimable');
            }
        });
    }

    async function claim(userRef, day) {
      let reward = null;
      try {
        const { committed, snapshot } = await userRef.transaction(user => {
          if (!user) return;
          const t = now();
          if (!user.meDailyState) {
            user.meDailyState = { currentDay: 1, nextAvailableAt: t, claimedDays: {} };
          }
          const state = user.meDailyState;

          if (day !== state.currentDay || t < state.nextAvailableAt) {
            return; // Abort
          }
          
          const rewardData = rewardFor(day);
          reward = rewardData;

          if (rewardData.type.startsWith('WLC')) user.balance = (user.balance || 0) + rewardData.amount;
          if (rewardData.type === 'USDT') user.usdtBalance = (user.usdtBalance || 0) + rewardData.amount;
          
          state.claimedDays = state.claimedDays || {};
          state.claimedDays[String(day)] = t;
          
          if (day >= 30) {
            state.currentDay = 1;
            state.claimedDays = {};
          } else {
            state.currentDay = day + 1;
          }
          state.nextAvailableAt = t + 24 * 3600 * 1000;
          
          user.meDailyState = state;
          return user;
        });

        if (committed && reward) {
          showPop(reward);
        }
      } catch (error) {
        console.error("Claim transaction failed:", error);
      }
    }

    // --- UI INTERACTION ---
    function showPop(reward) {
      const popReward = document.getElementById('pop-reward');
      document.getElementById('pop-title').textContent = 'Congratulations!';
      document.getElementById('pop-desc').textContent = 'Your daily reward has been added to your balance.';
      popReward.textContent = reward.label;
      popReward.className = 'reward';
      popReward.classList.add(reward.type.startsWith('WLC') ? 'wlc' : 'usdt');
      mask.classList.add('show');
    }
    popOk.addEventListener('click', () => mask.classList.remove('show'));

    // --- RANK SYSTEM ---
    const ranks = [
      { name: 'Iron', min: 0, next: 1500, img: 'iron.png' },
      { name: 'Bronze', min: 1500, next: 3000, img: 'bronze.png' },
      { name: 'Silver', min: 3000, next: 5000, img: 'silver.png' },
      { name: 'Gold', min: 5000, next: 8000, img: 'gold.png' },
      { name: 'Platinum', min: 8000, next: 10500, img: 'plat.png' },
      { name: 'Emerald', min: 10500, next: 15000, img: 'emrald.png' },
      { name: 'Diamond', min: 15000, next: 20000, img: 'diamon.png' },
      { name: 'Master', min: 20000, next: 30000, img: 'master.png' },
      { name: 'Grandmaster', min: 30000, next: 50000, img: 'grandmaster.png' },
      { name: 'Challenger', min: 50000, next: Infinity, img: 'challenger.png' }
    ];
    function updateRank(balance) {
      const currentRank = [...ranks].reverse().find(rank => balance >= rank.min);
      if (!currentRank) return;
      rankCadre.src = `assets/${currentRank.img}`;
      if (currentRank.next !== Infinity) {
        rankProgress.style.display = 'flex';
        const progress = Math.min(100, ((balance - currentRank.min) / (currentRank.next - currentRank.min)) * 100);
        progressFill.style.width = `${progress}%`;
        progressText.textContent = `${Math.floor(balance)} / ${currentRank.next}`;
      } else {
        rankProgress.style.display = 'none';
      }
    }

    // --- INITIALIZATION ---
    function init() {
      try {
        sessionStorage.setItem('wlc_user_id', String(userId));
        localStorage.setItem('wlc_user_id', String(userId));
      } catch {}

      const fullName = [tgUser?.first_name || '', tgUser?.last_name || ''].filter(Boolean).join(' ').trim() || 'Player';
      nameEl.textContent = fullName;
      
      buildGrid();
      
      const userRef = db.ref('users/' + userId);

      userRef.on('value', (snapshot) => {
        const userData = snapshot.val() || {};
        
        const wlcBalance = userData.balance || 0;
        const usdtBalance = userData.usdtBalance || 0;
        wlcEl.textContent = fmtWLC(wlcBalance);
        usdtEl.textContent = fmtUSD(usdtBalance);
        updateRank(wlcBalance);
        
        dailyState = userData.meDailyState;
        if (!dailyState) {
            const t = now();
            dailyState = { currentDay: 1, nextAvailableAt: t, claimedDays: {} };
        }
        renderDaily();
      });

      if (dailyTimerInterval) clearInterval(dailyTimerInterval);
      dailyTimerInterval = setInterval(renderDaily, 1000);
      
      achGrid.addEventListener('click', (e) => {
        const tile = e.target.closest('.day.claimable');
        if (tile) claim(userRef, Number(tile.dataset.day));
      });

      document.getElementById('back-btn').addEventListener('click', () => window.history.back());
      document.getElementById('cfg-btn').addEventListener('click', () => alert('Settings coming soon.'));
      document.getElementById('wlc-withdraw').addEventListener('click', () => alert('Withdraw WLC: Coming soon'));
      document.getElementById('usdt-withdraw').addEventListener('click', () => alert('Withdraw USDT: Coming soon'));
    }

    ensureUserId(init);
  </script>
</body>
</html>
