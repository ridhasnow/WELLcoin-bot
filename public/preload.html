<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <title>Loading...</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Tajawal', Arial, sans-serif;
      overflow: hidden;
      background: #16100b;
    }
    body {
      min-height: 100vh;
      position: relative;
    }
    .bg {
      position: fixed;
      inset: 0;
      z-index: 0;
      width: 100vw;
      height: 100vh;
      background: url('assets/preload.jpg') center bottom / cover no-repeat;
      filter: brightness(0.53) contrast(0.95) saturate(1.06);
    }
    .preload-card {
      position: absolute;
      z-index: 10;
      left: 50%;
      bottom: 5vh;
      transform: translateX(-50%);
      width: min(410px, 92vw);
      background: rgba(38,22,11,0.61);
      border-radius: 22px;
      box-shadow: 0 4px 16px 0 #0008;
      padding: 16px 10px 12px 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      border: 1.5px solid #ffb75b55;
      backdrop-filter: blur(1.5px);
      opacity: 0.92;
      min-height: 70px;
      max-height: 120px;
    }
    .preload-title {
      font-size: 1.1rem;
      color: #ffeab7;
      letter-spacing: 1px;
      margin-bottom: 4px;
      text-shadow: 0 2px 9px #ffddaa55;
      text-align: center;
    }
    .bar-box {
      width: 100%;
      margin: 8px 0 2px 0;
      background: #31210e;
      border-radius: 12px;
      box-shadow: 0 2px 8px #0008 inset;
      height: 11px;
      overflow: hidden;
      border: 1px solid #ffb75b33;
    }
    .bar-fill {
      transition: width 0.35s cubic-bezier(.65,.22,.19,1.14);
      height: 100%;
      background: linear-gradient(90deg, #ffc85c 3%, #ffa93a 80%, #ffeabd 100%);
      box-shadow: 0 3px 12px #ffbb4d22;
      width: 0%;
    }
    .bar-text {
      font-size: 0.97rem;
      color: #ffeab7;
      text-align: center;
      margin-top: 7px;
      letter-spacing: .5px;
      text-shadow: 0 2px 8px #34140044;
      opacity: 0.89;
      min-height: 18px;
    }
    .sound-btn {
      position: absolute;
      top: 18px;
      left: 16px;
      z-index: 20;
      width: 38px;
      height: 38px;
      border-radius: 50%;
      border: none;
      background: rgba(255,220,90,0.11);
      box-shadow: 0 0 0 1.5px #ffca5e44;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s;
    }
    .sound-btn:hover { background: rgba(255,220,90,0.17); }
    .sound-btn svg { width: 26px; height: 26px; fill: #fedb87; }
    .sound-btn.muted svg { fill: #7b5b24; opacity: 0.74; }
    @media (max-width: 600px) {
      .preload-card { padding: 8px 2px 7px 2px; }
      .preload-title { font-size: 0.95rem; }
      .sound-btn { top: 10px; left: 5px; width:32px; height:32px;}
      .bar-text { font-size: 0.91rem;}
    }
  </style>
</head>
<body>
  <div class="bg" id="bg"></div>
  <div class="preload-card">
    <div class="preload-title">Loading Game...</div>
    <div class="bar-box" id="barRole" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
      <div class="bar-fill" id="barFill"></div>
    </div>
    <div class="bar-text" id="barText" aria-live="polite">Preparing game, please wait...</div>
  </div>
  <button class="sound-btn" id="soundBtn" title="Play/Pause Music" aria-label="Play or mute music" aria-pressed="true" style="opacity:0.97;">
    <svg id="soundSVG" viewBox="0 0 26 26"><path d="M3 10.5v5h5l5.7 4.3c.5.4 1.3 0 1.3-.7v-16c0-.8-.8-1.1-1.3-.7L8 8.5H3zm18.5 2.5a7.5 7.5 0 0 0-3.5-6.2l-1 1.4c2.1 1.5 3 4.2 1.8 6.5l1.1 1.5c1.1-1.2 1.6-2.8 1.6-4.2zm-3.8 1.7l1.1 1.5a4.5 4.5 0 0 0 .7-5.5l-1.2 1.5a2.5 2.5 0 0 1-.6 2.5z"/></svg>
  </button>
  <script>
    // ---------- DOM Refs ----------
    const bgEl = document.getElementById('bg');
    const soundBtn = document.getElementById('soundBtn');
    const bar = document.getElementById('barFill');
    const barText = document.getElementById('barText');
    const barRole = document.getElementById('barRole');

    // ---------- IndexedDB Helper ----------
    const IDB_NAME = 'wellcoin_game_cache';
    const IDB_STORE = 'cache';
    const CACHE_VERSION_KEY = 'cache_version';
    const CACHE_VERSION = 'v1';
    const FORCE_CLEAR_CACHE = true; // keep current behavior; can turn off later

    function openIDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(IDB_NAME, 1);
        req.onupgradeneeded = function() {
          const db = req.result;
          if (!db.objectStoreNames.contains(IDB_STORE)) db.createObjectStore(IDB_STORE);
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }
    function idbSet(key, val) {
      return openIDB().then(db => new Promise((resolve, reject) => {
        const tx = db.transaction(IDB_STORE, 'readwrite');
        tx.objectStore(IDB_STORE).put(val, key);
        tx.oncomplete = resolve;
        tx.onerror = () => reject(tx.error);
      }));
    }
    function idbGet(key) {
      return openIDB().then(db => new Promise((resolve, reject) => {
        const tx = db.transaction(IDB_STORE, 'readonly');
        const req = tx.objectStore(IDB_STORE).get(key);
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      }));
    }
    function idbClear() {
      return openIDB().then(db => new Promise((resolve, reject) => {
        const tx = db.transaction(IDB_STORE, 'readwrite');
        tx.objectStore(IDB_STORE).clear();
        tx.oncomplete = resolve;
        tx.onerror = () => reject(tx.error);
      }));
    }

    // ---------- Audio System ----------
    let audioContext;
    let audioBuffer;
    let audioSource;
    let gainNode;

    function ensureAudioContext() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
      return audioContext;
    }
    function setSoundUI(isPlaying) {
      if (!soundBtn) return;
      if (isPlaying) {
        soundBtn.classList.remove('muted');
        soundBtn.setAttribute('aria-pressed', 'true');
      } else {
        soundBtn.classList.add('muted');
        soundBtn.setAttribute('aria-pressed', 'false');
      }
    }

    const audioState = {
      isPlaying: true,
      async play() {
        const ctx = ensureAudioContext();
        try {
          if (ctx.state === 'suspended') {
            await ctx.resume();
          }
        } catch(e) {
          // resume may be blocked without user gesture
        }
        if (audioBuffer && !audioSource) {
          audioSource = ctx.createBufferSource();
          audioSource.buffer = audioBuffer;
          audioSource.loop = true;

          gainNode = ctx.createGain();
          gainNode.gain.value = 0.76;

          audioSource.connect(gainNode);
          gainNode.connect(ctx.destination);

          try { audioSource.start(0); } catch(e) {}
        }
        this.isPlaying = true;
        if (gainNode) gainNode.gain.value = 0.76;
        setSoundUI(true);
      },
      pause() {
        if (gainNode) gainNode.gain.value = 0;
        this.isPlaying = false;
        setSoundUI(false);
      },
      toggle() {
        if (this.isPlaying) this.pause();
        else this.play();
      }
    };

    // Try to honor preference from welcome page
    const musicPreferred = sessionStorage.getItem('musicPreferred') === '1';

    let bgObjectUrl = null;

    async function preloadBackgroundAndMusic() {
      // Load background from cache if available
      try {
        const cachedBg = await idbGet('asset:assets/preload.jpg');
        if (cachedBg instanceof Blob) {
          if (bgObjectUrl) URL.revokeObjectURL(bgObjectUrl);
          bgObjectUrl = URL.createObjectURL(cachedBg);
          bgEl.style.background = `url(${bgObjectUrl}) center bottom / cover no-repeat`;
        }
      } catch(e) {}

      // Ensure background is loaded (network as fallback)
      await new Promise(resolve => {
        const bgImage = new Image();
        bgImage.onload = resolve;
        bgImage.onerror = resolve;
        bgImage.src = 'assets/preload.jpg';
      });

      // Load and setup audio buffer
      try {
        const cachedAudio = await idbGet('asset:assets/preload.mp3');
        if (cachedAudio instanceof Blob) {
          const arrayBuffer = await cachedAudio.arrayBuffer();
          audioBuffer = await ensureAudioContext().decodeAudioData(arrayBuffer);
        } else {
          const response = await fetch('assets/preload.mp3');
          const arrayBuffer = await response.arrayBuffer();
          audioBuffer = await ensureAudioContext().decodeAudioData(arrayBuffer);
        }
        // Attempt autoplay if user already interacted in welcome
        if (musicPreferred) {
          await audioState.play();
        } else {
          // keep UI in playing state by default as before
          await audioState.play().catch(()=>{});
        }
      } catch(e) {
        console.log('Audio setup failed:', e);
      }
    }

    // ---------- Event Handlers ----------
    soundBtn.addEventListener('click', () => audioState.toggle());
    document.addEventListener('keydown', e => {
      if (e.key === 'm' || e.key === 'M') audioState.toggle();
    });

    // Make sure first click resumes audio if needed
    document.addEventListener('click', () => {
      const ctx = ensureAudioContext();
      if (ctx.state === 'suspended') {
        ctx.resume().then(() => audioState.play());
      }
    }, { once: true });

    window.addEventListener('beforeunload', () => {
      if (bgObjectUrl) {
        URL.revokeObjectURL(bgObjectUrl);
        bgObjectUrl = null;
      }
    });

    // ---------- Progress Bar Logic ----------
    let progress = 0;
    let totalSteps = 1;
    let doneSteps = 0;
    function setProgress(pct, msg) {
      progress = Math.max(0, Math.min(100, pct|0));
      bar.style.width = progress + '%';
      if (barRole) barRole.setAttribute('aria-valuenow', String(progress));
      if (msg) barText.textContent = msg;
    }
    function incProgress() {
      doneSteps++;
      setProgress(Math.floor(doneSteps*100/totalSteps), "Preparing game, please wait...");
    }

    // ---------- Assets ----------
    const BASE_ASSETS = [
      "assets/bmwcar.jpg",
      "assets/bodyguards.png",
      "assets/character.png",
      "assets/character1.png",
      "assets/character10.png",
      "assets/character11.png",
      "assets/character12.png",
      "assets/character13.png",
      "assets/character2.png",
      "assets/character3.png",
      "assets/character4.png",
      "assets/character5.png",
      "assets/character6.png",
      "assets/character7.png",
      "assets/character8.png",
      "assets/character9.png",
      "assets/clock.png",
      "assets/dragon-frame.png",
      "assets/gangsterhat.png",
      "assets/helicopter.jpg",
      "assets/house.png",
      "assets/iphone15.png",
      "assets/palace.png",
      "assets/pitbull.png",
      "assets/player1.png",
      "assets/preload.jpg",
      "assets/preload.mp3",
      "assets/ranked-icon.png",
      "assets/royalthrone.png",
      "assets/shop.jpg",
      "assets/suit.png",
      "assets/wellcoin-icon.png",
      "assets/wife.png",
      "assets/yacht.jpg",
      "assets/ak.png"
    ];

    // ---------- Firebase Config ----------
    const firebaseConfig = {
      apiKey: "AIzaSyB9uNwUURvf5RsD7CnsG2LtE6fz5yboBkw",
      authDomain: "wellcoinbotgame.firebaseapp.com",
      databaseURL: "https://wellcoinbotgame-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "wellcoinbotgame",
      storageBucket: "wellcoinbotgame.appspot.com",
      messagingSenderId: "108640533638",
      appId: "1:108640533638:web:ed07516d96ac38f47f6507"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const tg = window.Telegram.WebApp;
    tg.ready();
    const tgUser = tg.initDataUnsafe?.user;
    const userId = tgUser?.id ? tgUser.id.toString() : null;

    // ---------- Main Preload Logic ----------
    async function preloadAll() {
      // 1) Background + Music
      await preloadBackgroundAndMusic();

      // 2) Clear cache (kept as-is for now)
      try {
        if (FORCE_CLEAR_CACHE) {
          await idbClear();
          await idbSet(CACHE_VERSION_KEY, CACHE_VERSION);
        } else {
          const v = await idbGet(CACHE_VERSION_KEY);
          if (v !== CACHE_VERSION) {
            await idbClear();
            await idbSet(CACHE_VERSION_KEY, CACHE_VERSION);
          }
        }
      } catch(e) {
        // non-fatal
      }

      // 3) Load assets
      totalSteps = 2 + BASE_ASSETS.length;
      setProgress(0, "Preparing game, please wait...");
      await Promise.all(BASE_ASSETS.map(src => {
        return new Promise(res => {
          if (src.endsWith('.mp3')) {
            fetch(src).then(r=>r.blob()).then(blob=>{
              idbSet('asset:'+src, blob).finally(()=>{ incProgress(); res(); });
            }).catch(()=>{ incProgress(); res(); });
          } else {
            const img = new Image();
            img.onload = () => { incProgress(); res(); };
            img.onerror = () => { incProgress(); res(); };
            img.src = src;
            fetch(src).then(r=>r.blob()).then(blob=>{
              idbSet('asset:'+src, blob);
            }).catch(()=>{});
          }
        });
      }));

      // 4) Load user data
      setProgress(Math.floor(doneSteps*100/totalSteps), "Loading player data...");
      if (!userId) {
        setProgress(100, "Please login via Telegram");
        return;
      }

      try {
        const userRef = db.ref("users/" + userId);
        const userSnap = await userRef.get();
        if (!userSnap.exists()) {
          setProgress(100, "Account not found. Please register.");
          setTimeout(()=>window.location.href="welcome.html", 1600);
          return;
        }
        incProgress();
        await idbSet('userData', userSnap.val());
      } catch(e) {
        console.error('Failed to load user:', e);
        setProgress(100, "Network error. Retrying may help.");
        // Keep going to avoid dead-end
      }

      // 5) Load shop items
      try {
        const shopSnap = await db.ref("users/" + userId + "/shopItems").get();
        if (shopSnap.exists()) {
          await idbSet('shopItems', shopSnap.val());
        }
      } catch(e) {
        // non-fatal
      }
      incProgress();

      // 6) Done -> go to game
      setProgress(100, "Ready! Entering the game...");
      setTimeout(()=>{
        window.location.replace('index.html');
      }, 700);
    }

    document.addEventListener('DOMContentLoaded', preloadAll);
  </script>
</body>
</html>
