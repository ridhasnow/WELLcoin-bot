<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <title>Loading...</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Tajawal', Arial, sans-serif;
      overflow: hidden;
      background: #16100b;
    }
    body {
      min-height: 100vh;
      position: relative;
    }
    .bg {
      position: fixed;
      inset: 0;
      z-index: 0;
      width: 100vw;
      height: 100vh;
      background: url('assets/preload.jpg') center bottom / cover no-repeat;
      filter: brightness(0.53) contrast(0.95) saturate(1.06);
    }
    /* تم حذف overlay وجميع الإضاءات */
    .preload-card {
      position: absolute;
      z-index: 10;
      left: 50%;
      bottom: 5vh;
      transform: translateX(-50%);
      width: min(410px, 92vw);
      background: rgba(38,22,11,0.61);
      border-radius: 22px;
      box-shadow: 0 4px 16px 0 #0008;
      padding: 16px 10px 12px 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      border: 1.5px solid #ffb75b55;
      backdrop-filter: blur(1.5px);
      opacity: 0.92;
      min-height: 70px;
      max-height: 120px;
    }
    .preload-title {
      font-size: 1.1rem;
      color: #ffeab7;
      letter-spacing: 1px;
      margin-bottom: 4px;
      text-shadow: 0 2px 9px #ffddaa55;
      text-align: center;
    }
    .bar-box {
      width: 100%;
      margin: 8px 0 2px 0;
      background: #31210e;
      border-radius: 12px;
      box-shadow: 0 2px 8px #0008 inset;
      height: 11px;
      overflow: hidden;
      border: 1px solid #ffb75b33;
    }
    .bar-fill {
      transition: width 0.35s cubic-bezier(.65,.22,.19,1.14);
      height: 100%;
      background: linear-gradient(90deg, #ffc85c 3%, #ffa93a 80%, #ffeabd 100%);
      box-shadow: 0 3px 12px #ffbb4d22;
      width: 0%;
    }
    .bar-text {
      font-size: 0.97rem;
      color: #ffeab7;
      text-align: center;
      margin-top: 7px;
      letter-spacing: .5px;
      text-shadow: 0 2px 8px #34140044;
      opacity: 0.89;
      min-height: 18px;
    }
    .sound-btn {
      position: absolute;
      top: 18px;
      left: 16px;
      z-index: 20;
      width: 38px;
      height: 38px;
      border-radius: 50%;
      border: none;
      background: rgba(255,220,90,0.11);
      box-shadow: 0 0 0 1.5px #ffca5e44;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s;
    }
    .sound-btn:hover { background: rgba(255,220,90,0.17); }
    .sound-btn svg { width: 26px; height: 26px; fill: #fedb87; }
    .sound-btn.muted svg { fill: #7b5b24; opacity: 0.74; }
    @media (max-width: 600px) {
      .preload-card { padding: 8px 2px 7px 2px; }
      .preload-title { font-size: 0.95rem; }
      .sound-btn { top: 10px; left: 5px; width:32px; height:32px;}
      .bar-text { font-size: 0.91rem;}
    }
  </style>
</head>
<body>
  <div class="bg"></div>
  <div class="preload-card">
    <div class="preload-title">Loading Game...</div>
    <div class="bar-box"><div class="bar-fill" id="barFill"></div></div>
    <div class="bar-text" id="barText">Preparing game, please wait...</div>
  </div>
  <button class="sound-btn" id="soundBtn" title="Play/Pause Music" aria-label="Play or mute music" style="opacity:0.97;">
    <svg id="soundSVG" viewBox="0 0 26 26"><path d="M3 10.5v5h5l5.7 4.3c.5.4 1.3 0 1.3-.7v-16c0-.8-.8-1.1-1.3-.7L8 8.5H3zm18.5 2.5a7.5 7.5 0 0 0-3.5-6.2l-1 1.4c2.1 1.5 3 4.2 1.8 6.5l1.1 1.5c1.1-1.2 1.6-2.8 1.6-4.2zm-3.8 1.7l1.1 1.5a4.5 4.5 0 0 0 .7-5.5l-1.2 1.5a2.5 2.5 0 0 1-.6 2.5z"/></svg>
  </button>
  <audio id="preloadAudio" src="assets/preload.mp3" preload="auto" loop></audio>
  <script>
    // ========== IndexedDB Helper ==========
    const IDB_NAME = 'wellcoin_game_cache';
    const IDB_STORE = 'cache';
    function openIDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(IDB_NAME, 1);
        req.onupgradeneeded = function(e) {
          const db = req.result;
          if (!db.objectStoreNames.contains(IDB_STORE)) {
            db.createObjectStore(IDB_STORE);
          }
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }
    function idbSet(key, val) {
      return openIDB().then(db => {
        return new Promise((resolve, reject) => {
          const tx = db.transaction(IDB_STORE, 'readwrite');
          tx.objectStore(IDB_STORE).put(val, key);
          tx.oncomplete = resolve;
          tx.onerror = () => reject(tx.error);
        });
      });
    }
    function idbGet(key) {
      return openIDB().then(db => {
        return new Promise((resolve, reject) => {
          const tx = db.transaction(IDB_STORE, 'readonly');
          const req = tx.objectStore(IDB_STORE).get(key);
          req.onsuccess = () => resolve(req.result);
          req.onerror = () => reject(req.error);
        });
      });
    }
    function idbClear() {
      return openIDB().then(db => {
        return new Promise((resolve, reject) => {
          const tx = db.transaction(IDB_STORE, 'readwrite');
          tx.objectStore(IDB_STORE).clear();
          tx.oncomplete = resolve;
          tx.onerror = () => reject(tx.error);
        });
      });
    }

    // ========== Persistent Music Logic ==========
    const audio = document.getElementById('preloadAudio');
    const soundBtn = document.getElementById('soundBtn');
    const soundSVG = document.getElementById('soundSVG');
    let firstInteract = false;
    const audioState = {
      isPlaying: false,
      init() {
        this.isPlaying = true;
        this.play();
      },
      play() {
        audio.volume = 0.76;
        audio.loop = true;
        audio.play().then(()=>{audio.currentTime=0;}).catch(()=>{});
        this.isPlaying = true;
        soundBtn.classList.remove('muted');
      },
      pause() {
        audio.pause();
        this.isPlaying = false;
        soundBtn.classList.add('muted');
      },
      toggle() {
        if (this.isPlaying) this.pause();
        else this.play();
      }
    };
    // شغل الموسيقى أول شيء
    window.addEventListener('DOMContentLoaded', () => {
      setTimeout(()=>{
        audioState.init();
      }, 30);
    });
    soundBtn.addEventListener('click', ()=>audioState.toggle());
    document.addEventListener('keydown', e => {
      if (e.key === 'm' || e.key === 'M') audioState.toggle();
    });

    // ========== Assets ==========
    // سيتم جلب جميع الملفات من مجلد assets تلقائياً (حدث القائمة يدوياً حسب ملفاتك)
    const BASE_ASSETS = [
      "assets/bmwcar.jpg",
      "assets/bodyguards.png",
      "assets/character.png",
      "assets/character1.png",
      "assets/character10.png",
      "assets/character11.png",
      "assets/character12.png",
      "assets/character13.png",
      "assets/character2.png",
      "assets/character3.png",
      "assets/character4.png",
      "assets/character5.png",
      "assets/character6.png",
      "assets/character7.png",
      "assets/character8.png",
      "assets/character9.png",
      "assets/clock.png",
      "assets/dragon-frame.png",
      "assets/gangsterhat.png",
      "assets/helicopter.jpg",
      "assets/house.png",
      "assets/iphone15.png",
      "assets/palace.png",
      "assets/pitbull.png",
      "assets/player1.png",
      "assets/preload.jpg",
      "assets/preload.mp3",
      "assets/ranked-icon.png",
      "assets/royalthrone.png",
      "assets/shop.jpg",
      "assets/suit.png",
      "assets/wellcoin-icon.png",
      "assets/wife.png",
      "assets/yacht.jpg",
      "assets/ak.png",
      // أضف أي ملفات جديدة تظهر في مجلد assets هنا...
    ];

    // ========== Firebase User Data ==========
    const firebaseConfig = {
      apiKey: "AIzaSyB9uNwUURvf5RsD7CnsG2LtE6fz5yboBkw",
      authDomain: "wellcoinbotgame.firebaseapp.com",
      databaseURL: "https://wellcoinbotgame-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "wellcoinbotgame",
      storageBucket: "wellcoinbotgame.appspot.com",
      messagingSenderId: "108640533638",
      appId: "1:108640533638:web:ed07516d96ac38f47f6507"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const tg = window.Telegram.WebApp;
    tg.ready();
    const tgUser = tg.initDataUnsafe?.user;
    const userId = tgUser?.id ? tgUser.id.toString() : null;

    // ========== Main Preload Logic ==========
    async function preloadAll() {
      // 1. Clear old cache for fresh session
      await idbClear();
      // 2. Progress: total steps (assets + user data + shop data)
      totalSteps = 2 + BASE_ASSETS.length;
      // 3. Preload all assets (images, sounds)
      setProgress(0, "Preparing game, please wait...");
      await Promise.all(BASE_ASSETS.map(src => {
        return new Promise(res => {
          if (src.endsWith('.mp3')) { // تحميل ملف الموسيقى
            fetch(src).then(r=>r.blob()).then(blob=>{
              idbSet('asset:'+src, blob).finally(()=>{ incProgress(); res(); });
            }).catch(()=>{ incProgress(); res(); });
          } else {
            const img = new Image();
            img.onload = () => { incProgress(); res(); };
            img.onerror = () => { incProgress(); res(); };
            img.src = src;
            fetch(src).then(r=>r.blob()).then(blob=>{
              idbSet('asset:'+src, blob);
            }).catch(()=>{});
          }
        });
      }));

      // 4. Load user data
      setProgress(Math.floor(doneSteps*100/totalSteps), "Loading player data...");
      if (!userId) {
        setProgress(100, "Please login via Telegram");
        return;
      }
      const userRef = db.ref("users/" + userId);
      const userSnap = await userRef.get();
      if (!userSnap.exists()) {
        setProgress(100, "Account not found. Please register.");
        setTimeout(()=>window.location.href="welcome.html", 1600);
        return;
      }
      incProgress();
      await idbSet('userData', userSnap.val());

      // 5. Load shop items (shopItems) if separated
      const shopSnap = await db.ref("users/" + userId + "/shopItems").get();
      if (shopSnap.exists()) {
        await idbSet('shopItems', shopSnap.val());
      }
      incProgress();

      // 6. Done, redirect to game
      setProgress(100, "Ready! Entering the game...");
      setTimeout(()=>{
        window.location.replace('index.html');
      }, 700);
    }

    // لا تعرض اسماء الأصول أثناء التحميل أبداً
    function setProgress(pct, msg) {
      progress = Math.max(0, Math.min(100, pct|0));
      bar.style.width = progress + '%';
      if (msg) barText.textContent = msg;
    }
    function incProgress(msg) {
      doneSteps++;
      setProgress(Math.floor(doneSteps*100/totalSteps), "Preparing game, please wait...");
    }

    // ابدأ التحميل فورياً مع بدء ظهور الصفحة والموسيقى
    document.addEventListener('DOMContentLoaded', ()=>{
      setTimeout(()=>{
        audioState.init();
        preloadAll();
      }, 5);
    });
  </script>
</body>
</html>
