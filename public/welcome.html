<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Welcome to WELLcoin</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600&display=swap" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body, html {
      height: 100%;
      font-family: 'Cinzel', serif;
      overflow: hidden;
      position: relative;
      color: white;
      background: #000;
    }
    video.bg-video {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      object-fit: cover;
      z-index: 0; /* كان -1 وتحت خلفية الصفحة */
    }
    .overlay {
      position: absolute; inset: 0;
      background: transparent;
      display: flex; flex-direction: column;
      justify-content: center; align-items: center;
      text-align: center; padding: 20px; z-index: 2;
    }
    .animated-text {
      font-size: 22px; max-width: 500px; margin-bottom: 40px;
      line-height: 1.5; color: #fff8dc;
      text-shadow: 0 1px 1px #000, 0 0 8px #ffd700;
      animation: fadeIn 4s ease-in-out;
    }
    @keyframes fadeIn { 0%{opacity:0;transform:translateY(20px)} 100%{opacity:1;transform:translateY(0)} }
    .agree-btn {
      padding: 12px 30px; font-size: 16px; font-weight: bold; color: #fff;
      background: #007bff; border: none; border-radius: 10px; cursor: pointer;
      box-shadow: 0 0 10px #007bff; transition: background .3s;
      -webkit-tap-highlight-color: transparent;
    }
    .agree-btn:hover { background: #0056b3; }
    .top-text { position: absolute; top: 30px; width: 100%; display: flex; justify-content: center; z-index: 2; }
    .bottom-btn { position: absolute; bottom: 40px; width: 100%; display: flex; justify-content: center; z-index: 2; }

    .popup {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: #111; padding: 30px; border-radius: 12px; box-shadow: 0 0 20px gold;
      display: none; flex-direction: column; align-items: center; z-index: 999;
    }
    .popup input {
      padding: 10px; border-radius: 6px; border: none; margin-bottom: 20px; width: 240px; text-align: center;
      background: #000; color: #fff; box-shadow: inset 0 0 0 1px #444;
    }
    .popup button {
      background: gold; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; color: #222;
      -webkit-tap-highlight-color: transparent;
    }
    .close-btn {
      position: absolute; top: 8px; right: 12px; font-size: 22px; color: white; cursor: pointer; font-weight: bold; z-index: 1000;
      -webkit-tap-highlight-color: transparent;
    }

    .block-access {
      position: fixed; inset: 0; background: #111; color: #fff;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      font-size: 1.4rem; z-index: 99999; text-align: center; padding: 0 16px;
    }
    .block-access a {
      background: #007bff; color: #fff; padding: 12px 32px; border-radius: 10px; text-decoration: none; font-weight: bold;
      margin-top: 35px; font-size: 1.1rem; box-shadow: 0 0 10px #007bff; transition: background 0.2s;
    }
    .block-access a:hover { background: #0056b3; }

    .security-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); color: #fff; display: none; align-items: center; justify-content: center; z-index: 100000; text-align: center; padding: 20px; font-size: 1rem; }

    /* Pre-welcome gate overlay: شفاف حتى لا يحجب الفيديو */
    #pre-welcome {
      position: fixed; inset: 0; background: transparent;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      z-index: 100000;
    }
    .loader-ring {
      width: 56px; height: 56px; border-radius: 50%;
      border: 3px solid rgba(255,255,255,0.15);
      border-top-color: #ffd700; animation: spin 0.9s linear infinite; margin-bottom: 14px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .pre-msg { color: #fff7cc; font-size: 14px; letter-spacing: .4px; opacity: 0.95; }

  </style>

  <!-- حماية أساسية -->
  <script>
    "use strict";
    (function harden() {
      document.addEventListener('contextmenu', e => e.preventDefault());
      ['copy','cut','paste','dragstart','selectstart'].forEach(ev => { document.addEventListener(ev, e => e.preventDefault()); });
      document.addEventListener('keydown', function(e) {
        const k = (e.key || '').toLowerCase();
        if (k === 'f12' || (e.ctrlKey && e.shiftKey && ['i','j','c'].includes(k)) || (e.metaKey && e.altKey && ['i','j','c'].includes(k)) || (e.ctrlKey && k === 'u') || (e.metaKey && k === 'u')) {
          e.preventDefault(); e.stopPropagation(); return false;
        }
      }, true);

      const secOverlay = document.createElement('div');
      secOverlay.className = 'security-overlay';
      secOverlay.innerHTML = 'Security mode active';
      document.addEventListener('DOMContentLoaded', () => document.body.appendChild(secOverlay));
      function devtoolsOpen() {
        let opened = false;
        if (window.outerWidth && window.innerWidth) {
          const wDiff = Math.abs(window.outerWidth - window.innerWidth);
          const hDiff = Math.abs(window.outerHeight - window.innerHeight);
          if (wDiff > 140 || hDiff > 160) opened = true;
        }
        try { const el = new Image(); Object.defineProperty(el, 'id', { get() { opened = true; return ''; } }); console.log('%c', el); } catch(_) {}
        return opened;
      }
      setInterval(() => { try { secOverlay.style.display = devtoolsOpen() ? 'flex' : 'none'; } catch(_) {} }, 900);
    })();
  </script>

  <!-- بوابة: السماح فقط داخل Telegram WebApp -->
  <script>
    (function gateTelegram() {
      function block() {
        document.body.innerHTML =
          '<div class="block-access">' +
          'Access denied.<br>Please open WELLcoin from Telegram app.<br>' +
          '<a href="https://t.me/WELLcoinGameBot?start=play" target="_blank" rel="noopener noreferrer">Open in Telegram</a>' +
          '</div>';
        throw new Error("Access blocked: must open from Telegram.");
      }
      const tg = window.Telegram && window.Telegram.WebApp;
      if (!(tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id)) {
        window.addEventListener('DOMContentLoaded', block);
      }
    })();
  </script>
</head>
<body>
  <!-- Background video -->
  <video id="bg-video" class="bg-video" autoplay muted playsinline loop>
    <source src="assets/background.mp4" type="video/mp4" />
  </video>

  <!-- Simple pre-welcome overlay (transparent) -->
  <div id="pre-welcome">
    <div class="loader-ring"></div>
    <div class="pre-msg" id="pre-msg">Preparing...</div>
  </div>

  <!-- Hidden audio for background music (best-effort autoplay) -->
  <audio id="bg-music" src="assets/preload.mp3" preload="auto" loop style="display:none"></audio>

  <div class="overlay" id="main-overlay" style="visibility:hidden">
    <div class="top-text">
      <div class="animated-text">
        Welcome, You Are Now On The Edge Of A New Gaming Realm. Soon, Your Skills Will Become A Source Of Real Wealth.<br />
        Are You Ready?
      </div>
    </div>
    <div class="bottom-btn">
      <button class="agree-btn" id="readyBtn">I'm Ready</button>
    </div>
  </div>

  <div class="popup" id="usernamePopup">
    <span class="close-btn" onclick="closePopup()">×</span>
    <input type="text" id="usernameInput" placeholder="Your name" readonly />
    <button id="saveBtn">Save</button>
  </div>

  <script>
    // ----- Firebase Config -----
    const firebaseConfig = {
      apiKey: "AIzaSyB9uNwUURvf5RsD7CnsG2LtE6fz5yboBkw",
      authDomain: "wellcoinbotgame.firebaseapp.com",
      databaseURL: "https://wellcoinbotgame-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "wellcoinbotgame",
      storageBucket: "wellcoinbotgame.appspot.com",
      messagingSenderId: "108640533638",
      appId: "1:108640533638:web:ed07516d96ac38f47f6507",
      measurementId: "G-3H07CXT2PF"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ----- Telegram WebApp Integration -----
    const tg = window.Telegram.WebApp;
    tg.ready();
    const tgUser = tg.initDataUnsafe?.user;
    const userId = tgUser?.id ? String(tgUser.id) : null;

    // compute display name from Telegram (first + last), no username fallback
    const firstName = (tgUser?.first_name || '').trim();
    const lastName  = (tgUser?.last_name  || '').trim();
    const displayName = (firstName || lastName) ? [firstName, lastName].filter(Boolean).join(' ').trim() : 'Player';
    const photoUrl = tgUser?.photo_url || '';

    const usernameField = document.getElementById("usernameInput");
    const saveBtn = document.getElementById("saveBtn");
    const readyBtn = document.getElementById("readyBtn");
    const preGate = document.getElementById('pre-welcome');
    const preMsg  = document.getElementById('pre-msg');
    const overlay = document.getElementById('main-overlay');
    const video   = document.getElementById("bg-video");
    const bgMusic = document.getElementById("bg-music");

    // ----- Helpers -----
    async function getPlayerDataFromFirebase(uid) {
      try {
        const snapshot = await db.ref("users/" + uid).get();
        return snapshot.exists() ? snapshot.val() : null;
      } catch (err) {
        return null;
      }
    }
    async function registerNewUserInFirebase() {
      const payload = {
        firstName, lastName,
        fullName: displayName,
        photoUrl: photoUrl || null,
        balance: 0,
        coinCount: 0,
        countdown: 10800,
        lastPlayed: Date.now(),
        joinedAt: new Date().toISOString()
      };
      return db.ref("users/" + userId).set(payload);
    }

    function showPopup() {
      document.getElementById("usernamePopup").style.display = "flex";
      try { video.muted = false; video.currentTime = 0; video.play().catch(()=>{}); } catch {}
    }
    function closePopup() {
      document.getElementById("usernamePopup").style.display = "none";
    }

    // Start background music softly (best-effort; may require user gesture on some devices)
    async function startMusic() {
      if (!bgMusic) return;
      try {
        if (!sessionStorage.getItem('wlc_music_started_at_ms')) {
          sessionStorage.setItem('wlc_music_started_at_ms', String(Date.now()));
          sessionStorage.setItem('wlc_music_track', 'assets/preload.mp3');
        }
      } catch {}
      bgMusic.volume = 0.76;
      try { await bgMusic.play(); } catch (e) { /* autoplay may be blocked; ignore */ }
    }

    function readyUI() {
      overlay.style.visibility = 'visible';
      readyBtn.onclick = showPopup;
      usernameField.value = displayName;
    }

    async function handleSaveOrReturn() {
      if (!userId) return;
      const exists = await getPlayerDataFromFirebase(userId);
      if (exists) {
        window.location.href = "preload.html?from=welcome";
      } else {
        try {
          await registerNewUserInFirebase();
          window.location.href = "preload.html?from=welcome";
        } catch (error) {
          alert("Error saving data: " + (error?.message || error));
        }
      }
    }

    async function initWelcome() {
      if (!userId) {
        document.body.innerHTML =
          '<div class="block-access">Access denied.<br>Please open WELLcoin from Telegram app.<br>' +
          '<a href="https://t.me/WELLcoinGameBot?start=play" target="_blank" rel="noopener noreferrer">Open in Telegram</a></div>';
        return;
      }

      // Start quick tasks in parallel: check user + warm video + start music
      const t0 = Date.now();
      const userPromise = getPlayerDataFromFirebase(userId);
      try {
        video.muted = true; // يضمن autoplay
        video.play().catch(()=>{}); // بدء الفيديو فورًا
      } catch {}
      startMusic();

      preMsg.textContent = "Checking your profile...";
      const playerData = await userPromise;

      // Configure Save / I'm Back strictly after we know the state
      if (playerData) {
        saveBtn.textContent = "I'm Back";
      } else {
        saveBtn.textContent = "Save";
      }
      saveBtn.onclick = handleSaveOrReturn;
      saveBtn.disabled = false;

      // little min time to avoid flicker
      const minDelay = 300;
      const elapsed = Date.now() - t0;
      if (elapsed < minDelay) await new Promise(r => setTimeout(r, minDelay - elapsed));

      // Hide pre-gate and show main overlay
      preGate.style.display = 'none';
      readyUI();
    }

    // ----- Initialize -----
    window.addEventListener("load", () => {
      saveBtn.disabled = true;
      initWelcome();
    });
  </script>
</body>
</html>
